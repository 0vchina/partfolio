<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Теплотехнический калькулятор — РБ (v2.2, авто-Rsi)</title>
<meta name="description" content="Пошаговый теплотехнический расчёт по РБ: авто-Rsi по типу конструкции, понятный вывод, печать/PDF.">
<style>
  :root{
    /* как у «ветровых» */
    --bg:#0b1020; --card:#111730; --ink:#eaf1ff; --muted:#b7c4e0; --line:#263166; --acc:#8ab4ff;
    --radius:16px; --shadow:0 8px 22px rgba(0,0,0,.35);
    --col-left:460px; --gap:16px; --max:1500px;
    --okbg:#0f2a22; --okb:#2dd4bf; --badbg:#2a0f13; --badb:#f87171; --warnbg:#2a2410; --warnb:#facc15;
  }
  *{box-sizing:border-box}
  html,body{height:100%; overflow-x:hidden}
  body{margin:0; font-family:Inter, system-ui, Arial, sans-serif; background:var(--bg); color:var(--ink)}
  .container{max-width:var(--max); margin:auto; padding:14px}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
  h1{margin:0; font-size:22px}
  .badge{font-size:12px; color:var(--muted)}
  .actions{display:flex; gap:8px}
  .actions .btn, .actions button{
    appearance:none; border:1px solid var(--line); background:#1a2340; color:var(--ink);
    padding:10px 14px; border-radius:10px; cursor:pointer; text-decoration:none; display:inline-block
  }
  .actions .btn:hover, .actions button:hover{background:#213058}

  .grid{
    display:grid;
    grid-template-columns: minmax(0,var(--col-left)) minmax(0,1.5fr);
    gap:var(--gap); margin-top:14px
  }
  @media (max-width: 1000px){ .grid{grid-template-columns:1fr} }

  .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); margin-bottom:16px; box-shadow:var(--shadow)}
  .card h2{margin:0; padding:12px 16px; border-bottom:1px solid rgba(255,255,255,.08); font-size:16px}
  .card .bd{padding:14px}

  label{font-size:12px; color:var(--muted); display:block; margin:4px 0}
  input,select,button{width:100%; border:1px solid #2a3564; border-radius:10px; padding:10px 12px; background:#0f1532; color:var(--ink); outline:none}
  input:focus,select:focus{border-color:#3b55b9; box-shadow:0 0 0 3px rgba(138,180,255,.18)}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width:640px){ .row{grid-template-columns:1fr} }
  .note{font-size:11px; color:var(--muted)}
  .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:#16203a; border:1px solid var(--line); font-size:12px}

  .kpi{display:grid; grid-template-columns: repeat(5,1fr); gap:10px}
  @media (max-width:1100px){ .kpi{grid-template-columns: repeat(3,1fr)} }
  @media (max-width:700px){ .kpi{grid-template-columns: repeat(2,1fr)} }
  .kpi .itm{background:#0f1532; border:1px solid #2a3564; border-radius:12px; padding:10px}
  .kpi .v{font-size:20px; font-weight:700}
  .kpi .t{font-size:12px; color:var(--muted)}

  /* Лэйаут слоёв */
  .layers-head,.layer{
    display:grid;
    grid-template-columns:minmax(130px,1.6fr) minmax(92px,0.8fr) minmax(110px,0.9fr) minmax(160px,1.1fr) 40px;
    gap:8px; align-items:center
  }
  .layers-head{font-size:12px; color:var(--muted); margin-top:8px}
  .layer input,.layer select{min-width:0}
  .layer .del{width:auto}

  @media (max-width:900px){
    .layers-head{grid-template-columns:1.5fr 0.8fr 0.9fr 1.1fr 40px}
  }
  @media (max-width:680px){
    .layers-head{display:none}
    .layer{
      grid-template-columns:1fr 1fr;
      grid-template-areas:"name name" "d lam" "preset del";
      gap:6px
    }
    .layer .name{grid-area:name}
    .layer .d{grid-area:d}
    .layer .lam{grid-area:lam}
    .layer .preset{grid-area:preset}
    .layer .del{grid-area:del; justify-self:end}
  }

  /* Таблица «Подробно» */
  .detail-table{border:1px solid #2a3564; border-radius:12px; overflow:hidden}
  .drow{display:grid; grid-template-columns:46px 1fr 90px 120px 130px; gap:8px; padding:8px 10px; border-bottom:1px dashed rgba(255,255,255,.08)}
  .drow.head{background:#0f1532; font-weight:600}
  .cell{min-width:0; font-size:14px}
  .truncate{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  @media (max-width:760px){ .drow{grid-template-columns:42px 1fr 78px 108px 108px} }
  @media (max-width:540px){
    .drow{grid-template-columns:44px 1fr 1fr; grid-template-areas:
      "num name name" "num d lam ri"}
    .cell.num{grid-area:num}
    .cell.name{grid-area:name}
    .cell.d{grid-area:d}
    .cell.lam{grid-area:lam}
    .cell.ri{grid-area:ri}
  }

  /* Вердикты */
  .ok{background:var(--okbg); border:1px solid var(--okb); padding:10px; border-radius:12px; font-size:14px}
  .bad{background:var(--badbg); border:1px solid var(--badb); padding:10px; border-radius:12px; font-size:14px}
  .warn{background:var(--warnbg); border:1px solid var(--warnb); padding:10px; border-radius:12px; font-size:14px}

  /* Вкладки */
  .tabs{display:flex; gap:8px; margin:10px 0}
  .tab{border:1px solid #2a3564; padding:6px 10px; border-radius:999px; background:#0f1532; color:var(--ink); font-size:13px; cursor:pointer}
  .tab.active{background:#27408f; border-color:#3b55b9}

  canvas{max-width:100%; background:#0f1532; border:1px dashed #2a3564; border-radius:12px}

  /* Печать — как в «ветровых» */
  .print-only{display:none}
  @media print{
    html,body{height:auto; overflow:visible}
    @page{size:A4 portrait; margin:12mm}
    .print-only{display:block}
    button,header,.actions{display:none!important}
    body{background:#fff; color:#000}
    .card{background:#fff; border:1px solid #ccc; box-shadow:none; break-inside:avoid; page-break-inside:avoid}
    .drow, .bd, .kpi, .layers-head{break-inside:avoid; page-break-inside:avoid}
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Теплотехнический калькулятор — РБ</h1>
        <div class="badge">R<sub>пр</sub>=R<sub>si</sub>+Σ(d/λ)+R<sub>se</sub> · авто-R<sub>si</sub> по типу конструкции</div>
      </div>
      <div class="actions">
        <a class="btn" href="https://0vchina.github.io/partfolio/">На главную</a>
        <button id="btnDraw">Обновить схему</button>
        <button id="btnPdf">Экспорт PDF</button>
        <button id="btnPrint">Печать / PDF</button>
      </div>
    </header>

    <div class="grid">
      <!-- Левая колонка: ввод -->
      <section class="card" aria-labelledby="inputs-h2">
        <h2 id="inputs-h2">Входные данные</h2>
        <div class="bd">
          <div class="row">
            <label>Тип конструкции
              <select id="ctype">
                <option value="wall">Наружная стена (Rн=3.2)</option>
                <option value="roof">Покрытие/чердачное (Rн=6.0)</option>
                <option value="basement">Перекрытие над неотапл. подвалом (Rн=2.5)</option>
                <option value="ground">Пол по грунту (см. прим.)</option>
              </select>
            </label>
            <label>Режим эксплуатации материалов (влияет на λ)
              <select id="regime">
                <option value="A">A — нормальный (ϕ≈75%)</option>
                <option value="B">B — увлажнённый (ϕ≈90%)</option>
              </select>
            </label>
          </div>

          <label style="display:flex; gap:8px; align-items:center; margin-top:6px">
            <input type="checkbox" id="advToggle" style="width:auto"> Показать «Расширенные» (ручной Rsi / Rse)
          </label>
          <div class="bd" id="advBox" style="display:none; padding:10px 0 0">
            <div class="row">
              <label>Rsi (внутр.), м²·°C/Вт
                <input id="advRsi" type="number" step="0.01" value="0.13">
              </label>
              <label>Rse (наруж.), м²·°C/Вт
                <input id="advRse" type="number" step="0.01" value="0.04">
              </label>
            </div>
            <div class="note">По умолчанию Rsi≈0.13 (стена), 0.10 (покрытие), 0.17 (поток вниз/перекрытие), Rse≈0.04 для стен/покрытий; для перекрытия над неотапл. подвалом и пола по грунту Rse=0.</div>
          </div>

          <!-- Слои -->
          <div class="layers-head" style="margin-top:10px">
            <div>Материал слоя</div>
            <div>Толщина, мм</div>
            <div>λ, Вт/(м·К)</div>
            <div>Пресет материала</div>
            <div></div>
          </div>
          <div id="layers"></div>

          <div class="bd" style="padding:10px 0 0">
            <div class="row">
              <div>
                <label>Кол-во слоёв
                  <input id="layersCount" type="number" min="1" step="1" value="4">
                </label>
              </div>
              <div style="display:flex; gap:8px; align-items:end">
                <button id="btnMinus">–</button>
                <button id="btnPlus">+</button>
                <button id="btnAdd">+ Слой</button>
                <button id="btnClear">Очистить</button>
              </div>
            </div>
          </div>

          <!-- Разрез -->
          <div style="margin-top:10px">
            <label>Схема разреза слоёв</label>
            <canvas id="sectionCanvas" width="980" height="120" aria-label="Схема разреза слоёв"></canvas>
            <div class="note">Ширина каждого прямоугольника пропорциональна толщине слоя. Цвет — по категории материала.</div>
          </div>
        </div>
      </section>

      <!-- Правая колонка: результат -->
      <section class="card" aria-labelledby="res-h2">
        <h2 id="res-h2">Результаты</h2>
        <div class="bd">
          <div class="kpi">
            <div class="itm"><div class="t">R<sub>si</sub></div><div class="v" id="kpi-rsi">—</div></div>
            <div class="itm"><div class="t">Σ(d/λ)</div><div class="v" id="kpi-rsum">—</div></div>
            <div class="itm"><div class="t">R<sub>se</sub></div><div class="v" id="kpi-rse">—</div></div>
            <div class="itm"><div class="t">R<sub>пр</sub></div><div class="v" id="kpi-rpr">—</div></div>
            <div class="itm"><div class="t">U=1/R</div><div class="v" id="kpi-u">—</div></div>
          </div>

          <div style="height:10px"></div>

          <div id="verdict" class="ok">—</div>

          <div class="tabs">
            <button class="tab active" id="tabBrief">Кратко</button>
            <button class="tab" id="tabDetail">Подробно по слоям</button>
          </div>

          <div id="paneBrief">
            <div class="pill" id="briefText">Rsi=— | Σ(d/λ)=— | Rse=— → Rпр=—</div>

            <div class="row" style="margin-top:6px">
              <div>
                <label><b>Подбор утеплителя (одним слоем)</b></label>
                <div class="row" style="margin-top:6px">
                  <label>Материал
                    <select id="insulMat"></select>
                  </label>
                  <label>λ утеплителя
                    <input id="lamIns" type="number" step="0.001" value="0.037">
                  </label>
                </div>
                <div class="row">
                  <label>Нужно добавить, мм
                    <input id="need" type="number" readonly>
                  </label>
                  <label>Дефицит R
                    <input id="deficit" type="text" readonly>
                  </label>
                </div>
                <div class="note" style="margin-top:6px">Если нужна многослойная система — добавьте утеплители в список слоёв и проверьте Σ(d/λ).</div>
              </div>
              <div>
                <b>Примечание по полу по грунту</b>
                <div id="groundNote" class="warn" style="margin-top:6px; display:none">
                  Для пола по грунту контроль по Приложению K (СП 2.04.01-2020). Здесь расчёт слоёв без учёта грунта.
                </div>
                <div id="notGround" class="note" style="margin-top:6px">
                  Для стен и покрытий Rse учитывается; для перекрытия над неотапл. подвалом и пола по грунту — Rse=0.
                </div>
              </div>
            </div>
          </div>

          <div id="paneDetail" style="display:none">
            <div id="layersTable" class="detail-table"></div>
            <div class="note" style="margin-top:6px">На узких экранах таблица превращается в компактные 2-рядные строки. Можно листать вбок при необходимости.</div>
          </div>

          <div class="print-only" style="margin-top:12px">
            <h2 style="margin:0 0 6px">Отчёт (кратко)</h2>
            <div class="note">Подробная таблица слоёв включена выше; при печати разбивка по страницам сохранится.</div>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
  /* ===== ДАННЫЕ ===== */
  const MATERIAL_GROUPS = [
    { group: "Утеплители", items: [
      { key:"mw",   name:"Минеральная вата",                lambdaA:0.037, lambdaB:0.040, cat:"insul" },
      { key:"mw150",name:"Базальтовая плита 150 кг/м³",    lambdaA:0.041, lambdaB:0.045, cat:"insul" },
      { key:"glassw",name:"Стекловата",                    lambdaA:0.040, lambdaB:0.044, cat:"insul" },
      { key:"eps",  name:"ПСБ (EPS)",                      lambdaA:0.036, lambdaB:0.038,  cat:"insul" },
      { key:"xps",  name:"XPS",                            lambdaA:0.032, lambdaB:0.034,  cat:"insul" },
      { key:"pur",  name:"Пенополиуретан (PUR)",           lambdaA:0.028, lambdaB:0.030,  cat:"insul" },
      { key:"ecow", name:"Эковата",                        lambdaA:0.040, lambdaB:0.045,  cat:"insul" },
    ]},
    { group: "Газо- и пенобетон", items: [
      { key:"aac3", name:"Газобетон D300",                 lambdaA:0.10,  lambdaB:0.12,  cat:"aac" },
      { key:"aac4", name:"Газобетон D400",                 lambdaA:0.12,  lambdaB:0.14,  cat:"aac" },
      { key:"aac5", name:"Газобетон D500",                 lambdaA:0.14,  lambdaB:0.16,  cat:"aac" },
      { key:"aac6", name:"Газобетон D600",                 lambdaA:0.16,  lambdaB:0.18,  cat:"aac" },
      { key:"foam", name:"Пенобетон монолитный",           lambdaA:0.35,  lambdaB:0.38,  cat:"lightcon" },
    ]},
    { group: "Кирпич", items: [
      { key:"brick_full", name:"Кирпич керамический полнотелый", lambdaA:0.81, lambdaB:0.87, cat:"brick" },
      { key:"brick_hole", name:"Кирпич керамический пустотелый", lambdaA:0.58, lambdaB:0.63, cat:"brick" },
      { key:"sil_full",   name:"Кирпич силикатный полнотелый",   lambdaA:0.87, lambdaB:0.93, cat:"brick" },
      { key:"sil_hole",   name:"Кирпич силикатный пустотелый",   lambdaA:0.65, lambdaB:0.71, cat:"brick" },
    ]},
    { group: "Бетоны и растворы", items: [
      { key:"concr", name:"Бетон тяжёлый",                 lambdaA:1.69,  lambdaB:1.75,  cat:"concrete" },
      { key:"lcon1400", name:"Бетон лёгкий (ρ≈1400)",      lambdaA:0.52,  lambdaB:0.56,  cat:"lightcon" },
      { key:"clc",   name:"Керамзитобетон (блок)",         lambdaA:0.43,  lambdaB:0.46,  cat:"lightcon" },
      { key:"mortar",name:"Раствор цементный",             lambdaA:1.00,  lambdaB:1.05,  cat:"concrete" },
      { key:"screed",name:"Стяжка цем.-песч.",             lambdaA:1.40,  lambdaB:1.45,  cat:"concrete" },
    ]},
    { group: "Дерево и плиты", items: [
      { key:"wood", name:"Дерево хвойное",                 lambdaA:0.18,  lambdaB:0.20,  cat:"wood" },
      { key:"wood_hard", name:"Дерево лиственное",         lambdaA:0.20,  lambdaB:0.22,  cat:"wood" },
      { key:"board_dry", name:"Доска сухая строганная",    lambdaA:0.15,  lambdaB:0.17,  cat:"wood" },
      { key:"osb3", name:"OSB-3",                          lambdaA:0.13,  lambdaB:0.15,  cat:"wood" },
      { key:"ply",  name:"Фанера",                         lambdaA:0.15,  lambdaB:0.17,  cat:"wood" },
      { key:"gkl",  name:"ГКЛ",                            lambdaA:0.25,  lambdaB:0.27,  cat:"board" },
    ]},
    { group: "Отделка / покрытие", items: [
      { key:"plstr",name:"Штукатурка цем.-песч.",          lambdaA:0.93,  lambdaB:1.00,  cat:"plaster" },
      { key:"gyp_pl",name:"Штукатурка гипсовая",           lambdaA:0.35,  lambdaB:0.40,  cat:"plaster" },
      { key:"tile", name:"Керамогранит/плитка",            lambdaA:1.00,  lambdaB:1.05,  cat:"tile" },
      { key:"roofmem",name:"Кровельная мембрана (оценочно)", lambdaA:0.20,lambdaB:0.22,  cat:"membrane" },
    ]},
  ];
  const RNORM = { wall:3.2, roof:6.0, basement:2.5, ground:0 };
  const RSE_OUT = 0.04;
  const CAT_COLORS = { insul:"#3f3a12", aac:"#1e2a55", lightcon:"#2d1f55", brick:"#3f171a", concrete:"#2a2e36", wood:"#4a2c15", board:"#3a214e", plaster:"#352452", tile:"#2a2e36", membrane:"#123b3b", other:"#2a2e36" };

  /* ===== Хелперы ===== */
  const $ = id => document.getElementById(id);
  const flatMaterials = MATERIAL_GROUPS.reduce((a,g)=>a.concat(g.items),[]);
  const num = v => { const n = typeof v==="string" ? parseFloat(v.replace(",", ".")) : Number(v); return isFinite(n)?n:0; };
  const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));
  const matByKey = k => flatMaterials.find(m=>m.key===k);
  const lambdaOf = (k, reg) => { const m = matByKey(k); return m ? (reg==="B" ? m.lambdaB : m.lambdaA) : 0.04; };
  const catColor = k => CAT_COLORS[(matByKey(k)||{}).cat || "other"] || CAT_COLORS.other;
  const fmt = (x,d=3)=> (isFinite(x)? (Math.round(x*10**d)/10**d).toFixed(d): "—");

  /* ===== авто Rsi/Rse ===== */
  function rsiAuto(ctype){
    if(ctype==='roof') return 0.10;                  // вверх
    if(ctype==='basement' || ctype==='ground') return 0.17; // вниз
    return 0.13;                                     // стены
  }
  function rseAuto(ctype){
    if(ctype==='wall' || ctype==='roof') return RSE_OUT;
    return 0; // basement/ground
  }

  /* ===== Состояние ===== */
  let manualR = false;
  let layers = [
    { name:"Штукатурка", d:15, lam:0.93,  matKey:"plstr" },
    { name:"Газобетон D400", d:300, lam:0.12, matKey:"aac4" },
    { name:"Минеральная вата", d:120, lam:0.037, matKey:"mw" },
    { name:"OSB-3", d:12, lam:0.13, matKey:"osb3" },
  ];

  /* ===== UI слои ===== */
  const layersBox = $('layers');
  function buildPresetSelect(i, currentKey){
    const preset = document.createElement('select'); preset.className='preset';
    const opt0 = document.createElement('option'); opt0.textContent = "— выбрать материал —"; preset.append(opt0);
    MATERIAL_GROUPS.forEach(gr=>{
      const og = document.createElement('optgroup'); og.label = gr.group;
      gr.items.forEach(m=>{
        const o = document.createElement('option'); o.value=m.key; o.textContent=m.name;
        if(m.key===currentKey) o.selected=true;
        og.append(o);
      });
      preset.append(og);
    });
    preset.onchange = () => {
      const k = preset.value;
      layers[i].matKey = k;
      const m = matByKey(k);
      if(m){
        layers[i].name = m.name;
        layers[i].lam  = lambdaOf(k, $('regime').value);
        const row = layersBox.querySelectorAll('.layer')[i];
        row.querySelector('.name').value = layers[i].name;
        row.querySelector('.lam').value  = layers[i].lam;
        recalc(); drawSection(); saveState();
      }
    };
    return preset;
  }

  function renderLayers(){
    layersBox.innerHTML = "";
    $('layersCount').value = layers.length;

    layers.forEach((L, i) => {
      const row = document.createElement('div'); row.className='layer';

      const name = document.createElement('input'); name.className='name truncate';
      name.value = L.name; name.oninput = e => { layers[i].name = e.target.value; saveState(); };

      const d = document.createElement('input'); d.className='d'; d.type='number'; d.step='1'; d.value=L.d;
      d.oninput = e => { layers[i].d = num(e.target.value); recalc(); drawSection(); saveState(); };

      const lam = document.createElement('input'); lam.className='lam'; lam.type='number'; lam.step='0.001'; lam.value=L.lam;
      lam.oninput = e => { layers[i].lam = num(e.target.value); recalc(); drawSection(); saveState(); };

      const preset = buildPresetSelect(i, L.matKey);

      const del = document.createElement('button'); del.className='del'; del.textContent='×'; del.title='Удалить';
      del.onclick = () => { layers.splice(i,1); renderLayers(); recalc(); drawSection(); saveState(); };

      row.append(name, d, lam, preset, del);
      layersBox.append(row);
    });
  }

  function ensureCount(n){
    n = clamp(n|0,1,100);
    const cur = layers.length;
    if(n>cur){ for(let i=0;i<n-cur;i++) layers.push({ name:"Новый слой", d:50, lam:0.037, matKey:"mw" }); }
    if(n<cur){ layers.splice(n, cur-n); }
    renderLayers(); recalc(); drawSection();
  }

  /* ===== Подбор утеплителя ===== */
  function fillInsulMat(){
    const sel = $('insulMat'); sel.innerHTML = "";
    const group = MATERIAL_GROUPS.find(g=>g.group==="Утеплители");
    group.items.forEach(m=>{ const o = document.createElement('option'); o.value=m.key; o.textContent=m.name; sel.append(o); });
    sel.value = sel.value || 'mw';
    updateInsulLambdaFromPreset();
  }
  const updateInsulLambdaFromPreset = ()=> $('lamIns').value = lambdaOf($('insulMat').value, $('regime').value).toFixed(3);

  /* ===== Расчёт ===== */
  function getRsiRse(){
    const ctype = $('ctype').value;
    if (manualR){
      return { Rsi: num($('advRsi').value)||0, Rse: num($('advRse').value)||0 };
    }
    return { Rsi: rsiAuto(ctype), Rse: rseAuto(ctype) };
  }

  function recalc(){
    const ctype = $('ctype').value;
    const { Rsi, Rse } = getRsiRse();
    const Rnorm = RNORM[ctype] ?? 0;

    let Rlayers = 0;
    layers.forEach(L=>{
      const d_m = num(L.d)/1000;
      const lam = Math.max(1e-6, num(L.lam));
      Rlayers += d_m/lam;
    });
    const Rpr = Rsi + Rlayers + Rse;
    const U = Rpr>0 ? (1/Rpr) : 0;

    // KPI
    $('kpi-rsi').textContent = fmt(Rsi,2);
    $('kpi-rse').textContent = fmt(Rse,2);
    $('kpi-rsum').textContent = fmt(Rlayers,3);
    $('kpi-rpr').textContent = fmt(Rpr,3);
    $('kpi-u').textContent = Rpr>0 ? fmt(U,4) : "—";

    const v = $('verdict');
    const groundNote = $('groundNote');
    const notGround = $('notGround');

    if (ctype==='ground'){
      v.className='warn';
      v.textContent = "Пол по грунту: итог по Приложению K (СП 2.04.01-2020). Здесь — проверка слоёв без учёта грунта.";
      groundNote.style.display = '';
      notGround.style.display = 'none';
    } else {
      groundNote.style.display = 'none';
      notGround.style.display = '';
      const ok = (Rnorm>0 && Rpr >= Rnorm);
      v.className = ok ? 'ok' : 'bad';
      v.textContent = Rnorm===0 ? '—' : (ok ? 'Ок: Rпр ≥ Rн. Конструкция соответствует требованию.' : `Недостаточно: не хватает ${(Rnorm - Rpr).toFixed(2)} м²·°C/Вт.`);
    }

    // Кратко
    const parts = [];
    parts.push(`Rsi=${fmt(Rsi,2)}`);
    parts.push(`Σ(d/λ)=${fmt(Rlayers,3)}`);
    if (Rse>0) parts.push(`Rse=${fmt(Rse,2)}`);
    parts.push(`→ Rпр=${fmt(Rpr,3)}`);
    if (Rnorm>0) parts.push(`; Rн=${fmt(Rnorm,2)}`);
    $('briefText').textContent = parts.join('  |  ');

    // Подбор утеплителя
    const deficit = Math.max(0, Rnorm - Rpr);
    $('deficit').value = deficit>0 ? deficit.toFixed(3) : "0.000";
    const lamIns = Math.max(1e-6, num($('lamIns').value) || 0.037);
    const add_mm = deficit > 0 ? Math.ceil(deficit * lamIns * 1000) : 0;
    $('need').value = add_mm;

    // Подробно
    renderLayersTable(Rsi, Rse);

    saveState();
  }

  function renderLayersTable(Rsi, Rse){
    const box = $('layersTable'); box.innerHTML = "";
    const header = drow(['#','Материал','d, мм','λ, Вт/(м·К)','R_i, м²·°C/Вт'], true);
    box.append(header);
    let Rlayers=0;
    layers.forEach((L,i)=>{
      const d_m = num(L.d)/1000;
      const lam = Math.max(1e-6, num(L.lam));
      const Ri = d_m/lam; Rlayers += Ri;
      box.append(drow([String(i+1), L.name, num(L.d).toFixed(0), num(L.lam).toFixed(3), Ri.toFixed(3)]));
    });
    // Итого и Rsi/Rse
    box.append(drow(['','Σ','', '', Rlayers.toFixed(3)], true));
    box.append(drow(['','Rsi','', '', Rsi.toFixed(2)]));
    if (Rse>0) box.append(drow(['','Rse','', '', Rse.toFixed(2)]));

    function drow(arr, head=false){
      const r = document.createElement('div');
      r.className = 'drow' + (head ? ' head' : '');
      const [cNum,cName,cD,cLam,cRi] = arr;

      const vNum = el('div','cell num', cNum);
      const vName= el('div','cell name truncate', cName);
      const vD   = el('div','cell d', cD);
      const vLam = el('div','cell lam', cLam);
      const vRi  = el('div','cell ri', cRi);

      r.append(vNum,vName,vD,vLam,vRi);
      return r;
    }
    function el(tag, cls, txt){ const e=document.createElement(tag); e.className=cls; e.textContent=txt; return e; }
  }

  /* ===== Схема разреза ===== */
  function drawSection(){
    const cnv=$('sectionCanvas'), ctx=cnv.getContext('2d');
    const W=cnv.width, H=cnv.height; ctx.clearRect(0,0,W,H);
    ctx.strokeStyle='#2a3564'; ctx.strokeRect(8,8,W-16,H-16);
    const total = layers.reduce((s,L)=>s+Math.max(0,num(L.d)),0);
    const x0=16, y0=36, h=40, innerW=W-32;
    if(!total){ ctx.fillStyle='#b7c4e0'; ctx.fillText('Добавьте толщины слоёв', x0+6, y0+18); return; }
    let x=x0;
    ctx.font='12px Inter, system-ui, Arial';
    layers.forEach((L,i)=>{
      const w=Math.max(2, innerW*(Math.max(0,num(L.d))/total));
      ctx.fillStyle=catColor(L.matKey); ctx.fillRect(x,y0,w,h);
      ctx.strokeStyle='#3c487a'; ctx.strokeRect(x,y0,w,h);
      ctx.fillStyle='#eaf1ff';
      const label=`${i+1}. ${L.name} (${num(L.d)} мм)`;
      let tx=x+4; const tw=ctx.measureText(label).width;
      if(tx+tw>x+w-4) tx=Math.max(x+4, x+w-4-tw);
      ctx.fillText(label, tx, y0+h+16);
      x+=w;
    });
  }

  /* ===== PDF ===== */
  async function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'mm', format:'a4' });
    let x=15,y=16;

    doc.setFontSize(14); doc.text('Теплотехнический расчёт — v2.2', x, y); y+=6;
    doc.setFontSize(10);
    const now = new Date();
    const ctypeText = $('ctype').selectedOptions[0].text;
    doc.text(`Тип: ${ctypeText} • Режим: ${$('regime').value} • ${now.toLocaleString()}`, x, y); y+=5;

    // Схема
    const figW=180, figH=16; const total = layers.reduce((s,L)=>s+Math.max(0,num(L.d)),0);
    doc.setDrawColor(160); doc.rect(x, y, figW, figH);
    let px=x;
    if(total){
      layers.forEach((L,i)=>{
        const w = Math.max(1, figW*(Math.max(0,num(L.d))/total));
        const col = hexToRgb(catColor(L.matKey));
        doc.setFillColor(col.r,col.g,col.b); doc.rect(px,y,w,figH,'F');
        doc.setDrawColor(80); doc.rect(px,y,w,figH);
        doc.setTextColor(20); doc.text(String(i+1), px+1.5, y+figH-2.2);
        px+=w;
      });
    } else {
      doc.text('Добавьте толщины слоёв', x+2, y+figH/1.6);
    }
    y += figH + 4;

    // Пошаговая формула
    const { Rsi, Rse } = getRsiRse();
    let Rlayers=0; layers.forEach(L=>{ const d=num(L.d)/1000, lam=Math.max(1e-6,num(L.lam)); Rlayers+=d/lam; });
    const Rpr = Rsi+Rlayers+Rse, U = Rpr>0? 1/Rpr : 0;
    const Rnorm = RNORM[$('ctype').value] ?? 0;

    doc.text(`Rпр = Rsi + Σ(d/λ) ${Rse>0?'+ Rse':''} = ${Rsi.toFixed(2)} + ${Rlayers.toFixed(3)} ${Rse>0?(' + '+Rse.toFixed(2)):""} = ${Rpr.toFixed(3)}`, x, y); y+=5;
    doc.text(`U = 1 / Rпр = ${U.toFixed(4)} Вт/(м²·°C)`, x, y); y+=5;
    if(Rnorm>0) doc.text(`Rнорм = ${Rnorm.toFixed(2)} → ${Rpr>=Rnorm ? 'СООТВЕТСТВУЕТ' : 'НЕ СООТВЕТСТВУЕТ (дефицит '+(Rnorm-Rpr).toFixed(3)+')'}`, x, y), y+=6;

    // Таблица слоёв
    doc.text('Слои:', x, y); y+=5;
    let cx=x;
    const cols=[8, 82, 24, 24, 26]; ['#','Материал','d, мм','λ','R_i'].forEach((t,i)=>{ doc.text(t, cx+1, y); cx+=cols[i]; });
    y+=2; doc.setDrawColor(160); doc.line(x,y,x+cols.reduce((a,b)=>a+b,0),y); y+=4;
    layers.forEach((L,i)=>{
      const d=num(L.d)/1000, lam=Math.max(1e-6,num(L.lam)), Ri=d/lam;
      cx=x; [String(i+1), L.name, num(L.d).toFixed(0), num(L.lam).toFixed(3), Ri.toFixed(3)].forEach((t,ci)=>{ doc.text(String(t), cx+1, y); cx+=cols[ci]; });
      y+=5; if(y>270){ doc.addPage(); y=16; }
    });

    // Подбор утеплителя
    const def = Math.max(0, Rnorm-Rpr);
    const lamIns = Math.max(1e-6, num($('lamIns').value)||0.037);
    const add_mm = def>0 ? Math.ceil(def*lamIns*1000) : 0;
    y+=2; doc.setDrawColor(160); doc.line(x,y,x+cols.reduce((a,b)=>a+b,0),y); y+=6;
    const insName = $('insulMat').selectedOptions[0]?.text || '—';
    doc.text(`Подбор утеплителя: ${insName}; λ=${lamIns.toFixed(3)} Вт/(м·К); дефицит R=${def.toFixed(3)}; нужно добавить ≈ ${add_mm} мм.`, x, y); y+=6;

    // Примечание
    doc.setTextColor(90);
    if($('ctype').value==='ground'){
      doc.text('Примечание: пол по грунту — проверка по Приложению K (СП 2.04.01-2020). Этот отчёт не учитывает сопротивление грунта.', x, y);
    } else {
      doc.text('Для неоднородных участков учитывайте коэффициент теплотехнической однородности.', x, y);
    }

    doc.save('thermal_calc_v2_2.pdf');

    function hexToRgb(hex){ const c = hex.replace('#',''); const v = c.length===3 ? c.split('').map(s=>s+s).join('') : c; const n = parseInt(v,16); return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 }; }
  }

  /* ===== Сохранение состояния ===== */
  function saveState(){
    const st = { ctype:$('ctype').value, regime:$('regime').value, manualR,
      advRsi:$('advRsi').value, advRse:$('advRse').value,
      layers: layers.map(L=>({ name:L.name, d:L.d, lam:L.lam, matKey:L.matKey })),
      insulMat:$('insulMat').value, lamIns:$('lamIns').value };
    localStorage.setItem('rb_thermal_v2_2_dark', JSON.stringify(st));
  }
  function loadState(){
    try{
      const s = JSON.parse(localStorage.getItem('rb_thermal_v2_2_dark')||'{}');
      if(s.ctype) $('ctype').value = s.ctype;
      if(s.regime) $('regime').value = s.regime;
      if(typeof s.manualR==='boolean'){ manualR = s.manualR; $('advToggle').checked = manualR; $('advBox').style.display = manualR? 'block':'none'; }
      if(s.advRsi) $('advRsi').value = s.advRsi;
      if(s.advRse) $('advRse').value = s.advRse;
      if(Array.isArray(s.layers) && s.layers.length){
        layers = s.layers.map(x=>({ name:x.name||"", d:num(x.d), lam:num(x.lam), matKey:x.matKey||"" }));
      }
      if(s.insulMat) $('insulMat').value = s.insulMat;
      if(s.lamIns) $('lamIns').value = s.lamIns;
    }catch(e){}
  }

  /* ===== События ===== */
  $('btnAdd').onclick = ()=>{ layers.push({ name:"Новый слой", d:50, lam:0.037, matKey:"mw" }); renderLayers(); recalc(); drawSection(); };
  $('btnClear').onclick = ()=>{ layers = [{ name:"Минеральная вата", d:100, lam:0.037, matKey:"mw" }]; renderLayers(); recalc(); drawSection(); };
  $('btnPlus').onclick = ()=> ensureCount(layers.length+1);
  $('btnMinus').onclick = ()=> ensureCount(layers.length-1);
  $('layersCount').oninput = e => ensureCount(num(e.target.value));

  $('ctype').onchange = ()=>{ if(!manualR){ $('advRse').value = rseAuto($('ctype').value).toFixed(2); $('advRsi').value = rsiAuto($('ctype').value).toFixed(2); } recalc(); };
  $('regime').onchange = ()=>{
    const reg = $('regime').value;
    layers = layers.map(L=>{
      if (L.matKey){
        const m = matByKey(L.matKey);
        if(m){ return { ...L, name:m.name, lam: lambdaOf(L.matKey, reg) }; }
      }
      return L;
    });
    renderLayers(); updateInsulLambdaFromPreset(); recalc(); drawSection();
  };

  $('advToggle').onchange = (e)=>{ manualR = e.target.checked; $('advBox').style.display = manualR? 'block':'none';
    if(!manualR){ $('advRsi').value = rsiAuto($('ctype').value).toFixed(2); $('advRse').value = rseAuto($('ctype').value).toFixed(2); }
    recalc(); };
  $('advRsi').oninput = recalc; $('advRse').oninput = recalc;

  $('insulMat').onchange = ()=>{ updateInsulLambdaFromPreset(); recalc(); };
  $('lamIns').oninput = ()=>{ recalc(); };

  $('btnDraw').onclick = drawSection;
  $('btnPdf').onclick  = exportPDF;
  $('btnPrint').onclick = ()=> window.print();

  $('tabBrief').onclick = ()=>{
    $('tabBrief').classList.add('active'); $('tabDetail').classList.remove('active');
    $('paneBrief').style.display=''; $('paneDetail').style.display='none';
  };
  $('tabDetail').onclick = ()=>{
    $('tabDetail').classList.add('active'); $('tabBrief').classList.remove('active');
    $('paneBrief').style.display='none'; $('paneDetail').style.display='';
  };

  /* ===== INIT ===== */
  function initAdvDefaults(){
    $('advRsi').value = rsiAuto($('ctype').value).toFixed(2);
    $('advRse').value = rseAuto($('ctype').value).toFixed(2);
  }
  window.addEventListener('beforeunload', ()=>saveState());

  function fillInsulMatInit(){
    const sel = $('insulMat'); sel.innerHTML = "";
    const group = MATERIAL_GROUPS.find(g=>g.group==="Утеплители");
    group.items.forEach(m=>{ const o = document.createElement('option'); o.value=m.key; o.textContent=m.name; sel.append(o); });
    sel.value = sel.value || 'mw'; updateInsulLambdaFromPreset();
  }

  renderLayers();
  initAdvDefaults();
  loadState();
  renderLayers();
  fillInsulMatInit();
  updateInsulLambdaFromPreset();
  recalc();
  drawSection();
</script>
</body>
</html>
