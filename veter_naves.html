<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Навесы · Ветровой калькулятор (плоский / односкатный / двускатный)</title>
  <meta name="description" content="Ветровые нагрузки на навесы: чистое давление (верх–низ), интерполяция cpe по уклону и площади, θ к коньку для двускатных. Печать/PDF с формулами.">
  <style>
    :root{
      --bg:#0b1020; --card:#111730; --ink:#eaf1ff; --muted:#b7c4e0; --line:#263166; --acc:#8ab4ff;
      --radius:16px; --shadow:0 8px 22px rgba(0,0,0,.35);
      --col-left:420px;
      --gap:16px;
      --max:1500px
    }
    *{box-sizing:border-box}
    html,body{height:100%; overflow-x:hidden}
    body{margin:0; font-family:Inter,system-ui,Arial,sans-serif; background:var(--bg); color:var(--ink)}
    .container{max-width:var(--max); margin:auto; padding:14px 14px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    h1{margin:0; font-size:22px}
    .badge{font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:8px}
    /* кнопки и ссылка-кнопка */
    .actions .btn, .actions button{
      appearance:none; border:1px solid var(--line); background:#1a2340; color:var(--ink);
      padding:10px 14px; border-radius:10px; cursor:pointer; text-decoration:none; display:inline-block
    }
    .actions .btn:hover, .actions button:hover{background:#213058}

    .grid{
      display:grid;
      grid-template-columns: minmax(0,var(--col-left)) minmax(0,1.5fr);
      gap:var(--gap); margin-top:14px
    }
    @media (max-width: 1000px){ .grid{grid-template-columns: 1fr} }

    .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); margin-bottom:16px; box-shadow:var(--shadow)}
    .card h2{margin:0; padding:12px 16px; border-bottom:1px solid rgba(255,255,255,.08)}
    .card .bd{padding:14px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:640px){ .row{grid-template-columns:1fr} }
    .card, .bd, .row > * { min-width:0 }

    label{font-size:12px; color:var(--muted); display:block; margin:4px 0}
    input, select, textarea{width:100%; padding:10px 12px; border-radius:10px; background:#0f1532; color:#eaf1ff; border:1px solid #2a3564; outline:none}
    input:focus, select:focus, textarea:focus{border-color:#3b55b9; box-shadow:0 0 0 3px rgba(138,180,255,.18)}
    .hint{font-size:11px; color:var(--muted); margin-top:6px; line-height:1.45}

    table{width:100%; border-collapse:collapse; font-size:14px; table-layout:fixed}
    th,td{padding:7px; border-bottom:1px dashed rgba(255,255,255,.08); text-align:right; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    th:first-child, td:first-child{text-align:left}
    #results table th, #results table td{
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }

    .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:#16203a; border:1px solid var(--line); font-size:12px}
    .legend{display:grid; gap:6px; margin-bottom:6px}
    .legend .item{font-size:12px; color:var(--muted)}

    .kpi{display:grid; grid-template-columns: repeat(4,1fr); gap:10px}
    @media (max-width:900px){ .kpi{grid-template-columns: repeat(2,1fr)} }
    .kpi .itm{background:#0f1532; border:1px solid #2a3564; border-radius:12px; padding:10px}
    .kpi .v{font-size:20px; font-weight:700}
    .kpi .t{font-size:12px; color:var(--muted)}

    /* СХЕМА */
    .scheme-wrap{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .scheme-caption{font-size:12px; color:var(--muted)}
    svg.scheme{width:100%; max-width:700px; height:auto; border:1px solid rgba(255,255,255,.08); border-radius:12px; background:#0f1532}

    .print-only{display:none}

    /* === ПРАВКИ ДЛЯ ПЕЧАТИ / PDF — исправляют обрезание на 1-й странице === */
    @media print{
      html, body{
        height:auto !important;
        overflow:visible !important;
        background:#fff !important;
        color:#000 !important;
      }
      @page{
        size:auto;
        margin:12mm;
      }
      header, .actions, button { display:none !important; }
      .grid{ display:block !important; }
      .container{ max-width:100% !important; padding:0 !important; }

      .card{
        background:#fff; border:1px solid #ccc; box-shadow:none;
        margin:0 0 12px 0;
        break-inside:avoid; page-break-inside:avoid;
      }
      .card .bd,
      #results table,
      #report{
        break-inside:auto; page-break-inside:auto;
      }
      table{ page-break-inside:auto; width:100%; table-layout:fixed; }
      tr{ page-break-inside:avoid; page-break-after:auto; }
      th, td{ white-space:normal; word-break:break-word; }

      .print-only{ display:block !important; }
      .report{ white-space:pre-wrap; font-family:Consolas, monospace; font-size:12px; line-height:1.45; }

      /* схема печатается «как есть» на всю ширину */
      svg.scheme{ background:#fff; border-color:#ddd }
    }
  </style>
</head>
<body>
  <div class="container">
    <header style="margin-bottom:6px">
      <div>
        <h1>Ветровой калькулятор — Навесы</h1>
        <div class="badge">Плоский / Односкатный / Двускатный · чистое давление (верх − низ)</div>
      </div>
      <div class="actions">
        <!-- Ссылка на главную страницу -->
        <a class="btn" href="https://0vchina.github.io/partfolio/">На главную</a>

        <button id="btn-calc">Рассчитать</button>
        <button id="btn-print">Печать / PDF</button>
        <button id="btn-copy">Копия отчёта</button>
      </div>
    </header>

    <div class="grid">
      <!-- Левая панель -->
      <section class="card" aria-labelledby="inputs-h2">
        <h2 id="inputs-h2">Входные данные</h2>
        <div class="bd">
          <!-- Геометрия -->
          <div class="row">
            <div>
              <label>b, м (поперёк ветра)</label>
              <input type="number" step="0.01" id="b" value="10">
              <div class="hint">Ширина покрытия поперёк фронта ветра.</div>
            </div>
            <div>
              <label>L, м (вдоль фронта ветра)</label>
              <input type="number" step="0.01" id="L" value="24">
            </div>
          </div>
          <div class="row">
            <div>
              <label>h, м (высота z<sub>e</sub>≈h)</label>
              <input type="number" step="0.01" id="H" value="5">
              <div class="hint">Для навеса с открытыми сторонами берём z<sub>e</sub>≈h (не ниже z<sub>min</sub>).</div>
            </div>
            <div>
              <label>Тип навеса</label>
              <select id="roofType">
                <option value="flat">Плоский</option>
                <option value="mono" selected>Односкатный</option>
                <option value="gable">Двускатный</option>
              </select>
            </div>
          </div>

          <!-- Уклон/ориентация -->
          <div class="row" id="slopeRow" style="display:flex">
            <div>
              <label>Уклон α, °</label>
              <input type="number" step="0.5" id="alpha" value="10">
            </div>
            <div id="flowDirWrap">
              <label>Направление по скату (односкатный)</label>
              <select id="flowDir">
                <option value="up" selected>Снизу вверх (к высокой кромке)</option>
                <option value="down">Сверху вниз (к низкой кромке)</option>
              </select>
            </div>
          </div>
          <div class="row" id="thetaRow" style="display:none">
            <div>
              <label>Ориентация к коньку θ (двускатный)</label>
              <select id="theta">
                <option value="90" selected>90° (ветер ⟂ коньку)</option>
                <option value="0">0° (ветер ∥ коньку)</option>
              </select>
            </div>
            <div></div>
          </div>

          <hr style="border:none; border-top:1px solid #223; margin:12px 0">

          <!-- Климат -->
          <div class="row">
            <div>
              <label>Ветровой район / v<sub>b,0</sub>, м/с</label>
              <div class="row">
                <select id="region"><option value="custom">Вручную</option><option value="I">I</option><option value="II" selected>II</option><option value="III">III</option></select>
                <input type="number" step="0.1" id="vb0" value="24">
              </div>
            </div>
            <div>
              <label>c<sub>dir</sub> / c<sub>season</sub></label>
              <div class="row">
                <input type="number" step="0.01" id="cdir" value="1.0">
                <input type="number" step="0.01" id="cseason" value="1.0">
              </div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Категория местности</label>
              <select id="terrain"><option value="0">0 — вода/берег</option><option value="I">I — открытая</option><option value="II" selected>II — сельхоз</option><option value="III">III — пригород/лес</option><option value="IV">IV — центр города</option></select>
            </div>
            <div>
              <label>Ороография cₒ(z)</label>
              <input type="number" step="0.01" id="co" value="1.0">
            </div>
          </div>

          <div class="row">
            <div>
              <label>ρ, кг/м³</label>
              <input type="number" step="0.01" id="rho" value="1.25">
            </div>
            <div>
              <label>k<sub>i</sub> (коэф. турбулентности)</label>
              <input type="number" step="0.01" id="ki" value="1.00">
            </div>
          </div>

          <div class="row">
            <div>
              <label>c<sub>s</sub>c<sub>d</sub> (структурный фактор)</label>
              <div class="row">
                <select id="cscdMode">
                  <option value="1">Не учитывать (1.0)</option>
                  <option value="auto" selected>Авто (1.0 для низких навесов)</option>
                  <option value="manual">Задать вручную</option>
                </select>
                <input type="number" step="0.01" id="cscd" value="1.00">
              </div>
            </div>
            <div>
              <label>Режим</label>
              <select id="mode"><option value="mwfrs" selected>Главная система (MWFRS)</option><option value="cladding">Ограждения/крепёж</option></select>
            </div>
          </div>

          <!-- Площадь элемента и e -->
          <div class="row">
            <div>
              <label>A, м² (для ограждений)</label>
              <input type="number" step="0.1" id="Aelem" value="20">
              <div class="hint">Лог-интерполяция c<sub>pe</sub>(A) между 1 и 10 м².</div>
            </div>
            <div>
              <label>Интерполяция по A</label>
              <select id="areaInterp"><option value="on" selected>Включена</option><option value="off">Выкл.</option></select>
            </div>
          </div>

          <details>
            <summary>Расширенные настройки (таблицы c<sub>pe</sub>)</summary>
            <div class="bd" style="padding:10px 0 0">
              <div class="row">
                <div>
                  <label>e = 0.2·min(b, 2h)</label>
                  <input type="number" step="0.01" id="eRoofFactor" value="0.2">
                </div>
                <div>
                  <label>Трение (опц.) c<sub>fr</sub></label>
                  <input type="number" step="0.01" id="cfr" value="0.02">
                  <div class="hint"><input type="checkbox" id="frictionOn" /> Учитывать суммарное трение</div>
                </div>
              </div>

              <!-- Плоский: top/bot (A=10 и A=1) -->
              <details>
                <summary>Плоский навес — верх/низ (F,G,H)</summary>
                <div class="row">
                  <div><label>TOP F,G,H · A=10</label><input id="flatTop10" value="-1.5,-1.0,-0.7"></div>
                  <div><label>TOP F,G,H · A=1</label> <input id="flatTop1"  value="-1.9,-1.3,-0.9"></div>
                </div>
                <div class="row">
                  <div><label>BOT F,G,H · A=10</label><input id="flatBot10" value="-0.5,-0.3,-0.2"></div>
                  <div><label>BOT F,G,H · A=1</label> <input id="flatBot1"  value="-0.7,-0.5,-0.3"></div>
                </div>
              </details>

              <!-- Односкатный: вверх ската / вниз ската -->
              <details>
                <summary>Односкатный — ВЕТЕР «ВВЕРХ СКАТА» (flow: up)</summary>
                <div class="row">
                  <div><label>α=5° TOP A=10/1</label><input id="monoUp5Top10" value="-1.1,-0.9,-0.6"><input id="monoUp5Top1" value="-1.4,-1.1,-0.8"></div>
                  <div><label>α=10° TOP</label><input id="monoUp10Top10" value="-1.2,-1.0,-0.7"><input id="monoUp10Top1" value="-1.5,-1.2,-0.9"></div>
                </div>
                <div class="row">
                  <div><label>α=15° TOP</label><input id="monoUp15Top10" value="-1.4,-1.1,-0.8"><input id="monoUp15Top1" value="-1.7,-1.4,-1.0"></div>
                  <div><label>α=30° TOP</label><input id="monoUp30Top10" value="-1.8,-1.4,-1.0"><input id="monoUp30Top1" value="-2.1,-1.7,-1.2"></div>
                </div>
                <div class="row">
                  <div><label>α=5° BOT</label><input id="monoUp5Bot10" value="-0.5,-0.3,-0.2"><input id="monoUp5Bot1" value="-0.7,-0.5,-0.3"></div>
                  <div><label>α=10° BOT</label><input id="monoUp10Bot10" value="-0.6,-0.4,-0.3"><input id="monoUp10Bot1" value="-0.8,-0.6,-0.4"></div>
                </div>
                <div class="row">
                  <div><label>α=15° BOT</label><input id="monoUp15Bot10" value="-0.7,-0.5,-0.4"><input id="monoUp15Bot1" value="-0.9,-0.7,-0.5"></div>
                  <div><label>α=30° BOT</label><input id="monoUp30Bot10" value="-0.9,-0.7,-0.5"><input id="monoUp30Bot1" value="-1.1,-0.9,-0.7"></div>
                </div>
              </details>

              <details>
                <summary>Односкатный — ВЕТЕР «ВНИЗ СКАТА» (flow: down)</summary>
                <div class="row">
                  <div><label>α=5° TOP</label><input id="monoDn5Top10" value="-0.9,-0.7,-0.5"><input id="monoDn5Top1" value="-1.2,-0.9,-0.7"></div>
                  <div><label>α=10° TOP</label><input id="monoDn10Top10" value="-1.0,-0.8,-0.6"><input id="monoDn10Top1" value="-1.3,-1.0,-0.8"></div>
                </div>
                <div class="row">
                  <div><label>α=15° TOP</label><input id="monoDn15Top10" value="-1.2,-0.9,-0.7"><input id="monoDn15Top1" value="-1.5,-1.2,-0.9"></div>
                  <div><label>α=30° TOP</label><input id="monoDn30Top10" value="-1.6,-1.2,-0.9"><input id="monoDn30Top1" value="-1.9,-1.5,-1.1"></div>
                </div>
                <div class="row">
                  <div><label>α=5° BOT</label><input id="monoDn5Bot10" value="-0.4,-0.3,-0.2"><input id="monoDn5Bot1" value="-0.6,-0.4,-0.3"></div>
                  <div><label>α=10° BOT</label><input id="monoDn10Bot10" value="-0.5,-0.4,-0.3"><input id="monoDn10Bot1" value="-0.7,-0.5,-0.4"></div>
                </div>
                <div class="row">
                  <div><label>α=15° BOT</label><input id="monoDn15Bot10" value="-0.6,-0.5,-0.4"><input id="monoDn15Bot1" value="-0.8,-0.6,-0.5"></div>
                  <div><label>α=30° BOT</label><input id="monoDn30Bot10" value="-0.8,-0.6,-0.5"><input id="monoDn30Bot1" value="-1.0,-0.8,-0.6"></div>
                </div>
              </details>

              <!-- Двускатный: θ=90° и θ=0°, зоны F,G,H,I -->
              <details>
                <summary>Двускатный — θ=90° (ветер ⟂ коньку): зоны F,G,H,I</summary>
                <div class="row">
                  <div><label>α=15° TOP (A=10/1)</label><input id="g90a15Top10" value="-0.9,-0.7,-0.5,-0.3"><input id="g90a15Top1" value="-1.2,-1.0,-0.7,-0.5"></div>
                  <div><label>α=30° TOP</label><input id="g90a30Top10" value="-1.1,-0.9,-0.6,-0.4"><input id="g90a30Top1" value="-1.4,-1.2,-0.8,-0.6"></div>
                </div>
                <div class="row">
                  <div><label>α=15° BOT</label><input id="g90a15Bot10" value="-0.5,-0.4,-0.3,-0.2"><input id="g90a15Bot1" value="-0.7,-0.6,-0.5,-0.3"></div>
                  <div><label>α=30° BOT</label><input id="g90a30Bot10" value="-0.6,-0.5,-0.4,-0.3"><input id="g90a30Bot1" value="-0.8,-0.7,-0.6,-0.4"></div>
                </div>
              </details>

              <details>
                <summary>Двускатный — θ=0° (ветер ∥ коньку): зоны F,G,H,I</summary>
                <div class="row">
                  <div><label>α=15° TOP</label><input id="g0a15Top10" value="0.2,-0.6,-0.9,-0.4"><input id="g0a15Top1" value="0.2,-0.9,-1.2,-0.6"></div>
                  <div><label>α=30° TOP</label><input id="g0a30Top10" value="0.2,-0.7,-1.0,-0.5"><input id="g0a30Top1" value="0.2,-1.0,-1.3,-0.7"></div>
                </div>
                <div class="row">
                  <div><label>α=15° BOT</label><input id="g0a15Bot10" value="-0.4,-0.3,-0.2,-0.2"><input id="g0a15Bot1" value="-0.6,-0.5,-0.3,-0.3"></div>
                  <div><label>α=30° BOT</label><input id="g0a30Bot10" value="-0.5,-0.4,-0.3,-0.3"><input id="g0a30Bot1" value="-0.7,-0.6,-0.4,-0.4"></div>
                </div>
              </details>

              <details>
                <summary>Карта ветровых районов (v<sub>b,0</sub>)</summary>
                <div class="row">
                  <div><label>v<sub>b,0</sub> для I/II/III (м/с)</label><input id="regionsMap" value="22,24,26"></div>
                  <div><label class="hint">Подставляется при выборе района.</label></div>
                </div>
              </details>

              <details>
                <summary>Высота отсчёта z<sub>e</sub></summary>
                <div class="row">
                  <div><label>Режим</label><select id="zeMode"><option value="auto" selected>Авто (z<sub>e</sub>=h)</option><option value="manual">Вручную</option></select></div>
                  <div></div>
                </div>
                <div class="row" id="zeManualRow" style="display:none">
                  <div><label>z<sub>e</sub>, м</label><input type="number" step="0.1" id="zeExt" value="5"></div>
                  <div></div>
                </div>
              </details>
            </div>
          </details>
        </div>
      </section>

      <!-- Правая панель -->
      <section class="card" aria-labelledby="results-h2">
        <h2 id="results-h2">Результаты</h2>
        <div class="bd" id="results">
          <div class="legend" id="legend"></div>

          <!-- СХЕМА -->
          <div class="scheme-wrap" style="margin:8px 0 14px">
            <svg id="scheme" class="scheme" viewBox="0 0 800 300" role="img" aria-label="Схема покрытия и зон"></svg>
            <div class="scheme-caption" id="scheme-caption">Схема покрытий: F — кромка, G — краевые, H — центр, I — подветренная половина (для двускатной θ=90°).</div>
          </div>

          <div class="kpi">
            <div class="itm"><div class="t">v<sub>b,0</sub></div><div class="v" id="kpi-vb0">—</div></div>
            <div class="itm"><div class="t">v<sub>b</sub></div><div class="v" id="kpi-vb">—</div></div>
            <div class="itm"><div class="t">I<sub>v</sub>(h)</div><div class="v" id="kpi-iv">—</div></div>
            <div class="itm"><div class="t">q<sub>p</sub>(h), Па</div><div class="v" id="kpi-qp">—</div></div>
          </div>

          <div style="height:10px"></div>
          <div id="cases"></div>

          <div class="print-only" style="margin-top:10px">
            <h2 style="margin:0 0 6px">Подробный отчёт (формулы)</h2>
            <div id="report" class="report">—</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ===== Константы и утилиты
    const Z0_MAP={"0":0.003,"I":0.01,"II":0.05,"III":0.3,"IV":1.0};
    const ZMIN_MAP={"0":1,"I":1,"II":2,"III":5,"IV":10};
    const RHO_DEF=1.25;
    const clamp=(v,min,max)=>Math.min(Math.max(v,min),max);
    const fmt=(v,d=2)=>Number.isFinite(v)?Number(v).toFixed(d):'—';
    const $=s=>document.querySelector(s);
    function parseList(str,expect){ const arr=String(str).split(/[,;\s]+/).filter(Boolean).map(Number); while(arr.length<expect) arr.push(arr[arr.length-1] ?? 0); return arr.slice(0,expect); }
    const log10=(x)=>Math.log(x)/Math.log(10);
    const lerp=(a,b,t)=>a+(b-a)*t;

    // ===== Профиль скорости / qp (наружный поток)
    function kCoef(z0){return 0.19*Math.pow(z0/0.05,0.07)}
    function cr(z,z0){ const zc=Math.max(z, 1.0001*z0); return kCoef(z0)*Math.log(zc/z0); }
    function Iv(z,z0,co=1,ki=1){ const zc=Math.max(z, 1.0001*z0); return (ki*co/Math.log(zc/z0)) * Math.pow(z0/0.05, 0.07); }
    function peakPressure(rho, vb, z, z0, co, ki=1){ const vm = cr(z,z0) * (co||1) * vb; const iv = Iv(z,z0, co||1, ki); const qp = 0.5 * rho * vm * vm * (1 + 7*iv); return { vm, iv, qp }; }

    // ===== Геометрия зон
    function eRoof(b,H){ const k=parseFloat($('#eRoofFactor').value)||0.2; return k * Math.min(b, 2*H); }

    // ===== Интерполяции cpe
    function cpeAreaInterp(c10, c1, A){
      if($('#areaInterp').value==='off') return c10;
      if(!(A>0)) return c10;
      if(A<=1) return c1;
      if(A>=10) return c10;
      return c1 - (c1 - c10)*log10(A); // логарифмическая по A
    }
    function pickLerp(alpha, a0, a1, set0, set1){ // линейно по уклону
      const t=clamp((alpha-a0)/(a1-a0),0,1);
      return set0.map((v,i)=> lerp(v, set1[i], t));
    }

    // ===== Наборы коэффициентов
    function setsFlat(A){
      const top10=parseList($('#flatTop10').value,3), top1=parseList($('#flatTop1').value,3);
      const bot10=parseList($('#flatBot10').value,3), bot1=parseList($('#flatBot1').value,3);
      return {
        zones:['F','G','H'],
        top:[0,1,2].map(i=> cpeAreaInterp(top10[i], top1[i], A)),
        bot:[0,1,2].map(i=> cpeAreaInterp(bot10[i], bot1[i], A))
      };
    }

    function setsMono(A, alphaDeg, flow){ // flow: 'up' | 'down'
      const pref = flow==='up' ? 'monoUp' : 'monoDn';
      const a=[5,10,15,30];
      const t10 = a.map(v=> parseList($(`#${pref}${v}Top10`).value,3));
      const t1  = a.map(v=> parseList($(`#${pref}${v}Top1`).value ,3));
      const b10 = a.map(v=> parseList($(`#${pref}${v}Bot10`).value,3));
      const b1  = a.map(v=> parseList($(`#${pref}${v}Bot1`).value ,3));

      function interp(arr, alpha){
        if(alpha<=a[0]) return arr[0];
        if(alpha>=a[a.length-1]) return arr[a.length-1];
        for(let i=0;i<a.length-1;i++){
          if(alpha>=a[i] && alpha<=a[i+1]){
            return pickLerp(alpha, a[i], a[i+1], arr[i], arr[i+1]);
          }
        }
        return arr[arr.length-1];
      }
      const top10 = interp(t10, alphaDeg), top1 = interp(t1, alphaDeg);
      const bot10 = interp(b10, alphaDeg), bot1 = interp(b1, alphaDeg);

      return {
        zones:['F','G','H'],
        top:[0,1,2].map(i=> cpeAreaInterp(top10[i], top1[i], A)),
        bot:[0,1,2].map(i=> cpeAreaInterp(bot10[i], bot1[i], A))
      };
    }

    function setsGable(A, alphaDeg, theta){ // theta: '90' | '0'
      const tag = (theta==='90') ? 'g90' : 'g0';
      const a0=15, a1=30;
      const t10a0=parseList($(`#${tag}a15Top10`).value,4), t1a0=parseList($(`#${tag}a15Top1`).value,4);
      const t10a1=parseList($(`#${tag}a30Top10`).value,4), t1a1=parseList($(`#${tag}a30Top1`).value,4);
      const b10a0=parseList($(`#${tag}a15Bot10`).value,4), b1a0=parseList($(`#${tag}a15Bot1`).value,4);
      const b10a1=parseList($(`#${tag}a30Bot10`).value,4), b1a1=parseList($(`#${tag}a30Bot1`).value,4);

      const top10 = pickLerp(alphaDeg, a0, a1, t10a0, t10a1);
      const top1  = pickLerp(alphaDeg, a0, a1, t1a0 , t1a1 );
      const bot10 = pickLerp(alphaDeg, a0, a1, b10a0, b10a1);
      const bot1  = pickLerp(alphaDeg, a0, a1, b1a0 , b1a1 );

      return {
        zones:['F','G','H','I'],
        top: top10.map((v,i)=> cpeAreaInterp(v, top1[i], A)),
        bot: bot10.map((v,i)=> cpeAreaInterp(v, bot1[i], A))
      };
    }

    // ===== Режимы
    function getCscd(apply){
      const m=$('#cscdMode').value;
      if(!apply) return 1.0;
      if(m==='manual') return Math.max(0.5, parseFloat($('#cscd').value)||1);
      return 1.0;
    }

    // ===== Таблица
    function buildTable(title,note,rows){
      const thead = `<thead>
        <tr>
          <th>Зона</th>
          <th>Описание</th>
          <th>c<sup>top</sup></th>
          <th>c<sup>bot</sup></th>
          <th>c<sub>net</sub>=top−bot</th>
          <th>w<sub>net</sub>=c<sub>net</sub>·q<sub>p</sub>·(c<sub>s</sub>c<sub>d</sub>)</th>
        </tr>
      </thead>`;
      const desc = (z)=>({
        F:'Кромка (F)',
        G:'Краевые (G)',
        H:'Центр (H)',
        I:'Подветренная половина (I)'
      }[z] || `Зона ${z}`);
      const tbody = `<tbody>${
        rows.map(r => `<tr>
          <td><b>${r.zone}</b></td>
          <td style="text-align:left">${desc(r.zone)}</td>
          <td>${fmt(r.cTop,2)}</td>
          <td>${fmt(r.cBot,2)}</td>
          <td>${fmt(r.cNet,2)}</td>
          <td>${fmt(r.wnet,0)}</td>
        </tr>`).join('')
      }</tbody>`;
      return `<div class="card" style="margin-top:12px"><div class="hd"><h2>${title}</h2><span class="pill">${note}</span></div><div class="bd"><table>${thead+tbody}</table></div></div>`;
    }

    // ===== Отчёт
    function headerReport(ctx){
      const {b,L,H,roofType,alpha,flowDir,theta,region,vb0,cdir,cseason,terrain,z0,zmin,co,ze,rho,ki,vb,ext,mode,cscd,A,e}=ctx;
      const lines=[];
      lines.push('— ВХОДНЫЕ ДАННЫЕ —');
      lines.push(`Геометрия: b=${fmt(b,2)} м; L=${fmt(L,2)} м; h=${fmt(H,2)} м; e=${fmt(e,2)} м`);
      const rt = roofType==='flat'?'плоский':(roofType==='mono'?`односкатный (α=${fmt(alpha,1)}°; ${flowDir==='up'?'ветер вверх ската':'ветер вниз ската'})`:`двускатный (α=${fmt(alpha,1)}°, θ=${theta}°)`);
      lines.push(`Тип: ${rt}`);
      lines.push(`Регион=${region}; v_b,0=${fmt(vb0,1)} м/с; c_dir=${fmt(cdir,2)}; c_season=${fmt(cseason,2)}; v_b=${fmt(vb,2)} м/с`);
      lines.push(`Местность: ${terrain} → z₀=${z0} м; z_min=${zmin} м; cₒ=${fmt(co,2)}; ρ=${fmt(rho,2)}; k_i=${fmt(ki,2)}`);
      lines.push(`z_e=${fmt(ze,2)} м; A=${fmt(A,2)} м²; режим: ${mode}; c_s c_d=${fmt(cscd,2)}`);

      lines.push('\n— ПРОФИЛЬ СКОРОСТИ И ПИКОВОЕ ДАВЛЕНИЕ —');
      lines.push(`c_r(z_e)=${fmt(cr(ze,z0),4)}; v_m=c_r·cₒ·v_b=${fmt(ext.vm,3)} м/с; I_v=${fmt(ext.iv,4)}; q_p=0.5·ρ·v_m²·(1+7I_v)=${fmt(ext.qp,0)} Па`);
      return lines;
    }

    function rowsReport(title, rows, qp, cscd){
      const lines=[`\n— ${title} —`];
      rows.forEach(r=>{
        lines.push(`\nЗона ${r.zone}: c_top=${fmt(r.cTop,2)}, c_bot=${fmt(r.cBot,2)}, c_net=${fmt(r.cNet,2)}`);
        lines.push(`w_net = c_net · q_p · (c_s c_d) = ${fmt(r.cNet,2)} · ${fmt(qp,0)} · ${fmt(cscd,2)} = ${fmt(r.wnet,0)} Па`);
      });
      return lines;
    }

    // ===== Схема (SVG)
    function drawScheme(){
      const svg = document.getElementById('scheme');
      if(!svg) return;
      const roofType=$('#roofType').value;
      const alpha=parseFloat($('#alpha').value||'0');
      const flowDir=$('#flowDir').value;
      const theta=$('#theta').value;
      const b=parseFloat($('#b').value);
      const H=parseFloat($('#H').value);
      const e = (parseFloat($('#eRoofFactor').value)||0.2) * Math.min(b, 2*H);

      // очистка
      while(svg.firstChild) svg.removeChild(svg.firstChild);

      // helpers
      const NS='http://www.w3.org/2000/svg';
      const add = (name, attrs={}, parent=svg)=>{
        const el=document.createElementNS(NS,name);
        Object.entries(attrs).forEach(([k,v])=> el.setAttribute(k, String(v)));
        parent.appendChild(el); return el;
      };
      const label = (x,y,text,opts={})=>{
        add('text', {x, y, 'font-size': opts.size||14, 'text-anchor': opts.anchor||'middle', 'fill': opts.fill||'#eaf1ff'}, svg).textContent=text;
      };

      // рамка рабочей области
      add('rect',{x:10,y:10,width:780,height:280,rx:12,ry:12,fill:'#0b1235',stroke:'#2a3564'});

      // стрелка ветра слева направо
      const arrowY=50;
      add('line',{x1:40,y1:arrowY,x2:200,y2:arrowY,stroke:'#8ab4ff','stroke-width':3,'marker-end':'url(#arrow)'});      
      label(120, arrowY-10, 'ветер', {size:12, fill:'#8ab4ff'});

      // дефиним маркер-стрелку
      const defs=add('defs',{},svg);
      const marker=add('marker',{id:'arrow',viewBox:'0 0 10 10',refX:'10',refY:'5',markerWidth:'8',markerHeight:'8',orient:'auto-start-reverse'},defs);
      add('path',{d:'M 0 0 L 10 5 L 0 10 z', fill:'#8ab4ff'},marker);

      // площадка покрытия
      const plateX=120, plateY=110, plateW=560, plateH=120;

      // базовая плита
      add('rect',{x:plateX,y:plateY,width:plateW,height:plateH,fill:'#13204a',stroke:'#415a9a'});

      // уклон / форма
      if(roofType==='flat'){
        // зоны: F (кромка наветренная), G (краевые), H (центр)
        const ePix = clamp(e / Math.max(b,1) * plateH * 0.6, 12, plateH*0.35);
        // F (наветренная кромка)
        add('rect',{x:plateX,y:plateY,width:plateW, height: ePix, fill:'rgba(255,255,255,0.06)', stroke:'#7aa2ff'});
        label(plateX+30, plateY+ePix/2+5, 'F', {size:16});
        // G (боковые+подветренная) — две полосы снизу/середина
        add('rect',{x:plateX,y:plateY+ePix,width:plateW, height: ePix, fill:'rgba(255,255,255,0.05)', stroke:'#7aa2ff','stroke-dasharray':'4,4'});
        label(plateX+30, plateY+ePix+ePix/2+5, 'G', {size:16});
        // H (центр)
        add('rect',{x:plateX,y:plateY+2*ePix,width:plateW, height: plateH-2*ePix, fill:'rgba(255,255,255,0.03)', stroke:'#7aa2ff','stroke-dasharray':'2,6'});
        label(plateX+30, plateY+2*ePix+(plateH-2*ePix)/2+5, 'H', {size:16});

        // размер e
        add('line',{x1:plateX+plateW+15,y1:plateY,x2:plateX+plateW+15,y2:plateY+ePix,stroke:'#9ec3ff','stroke-width':2});
        add('line',{x1:plateX+plateW+10,y1:plateY,x2:plateX+plateW+20,y2:plateY,stroke:'#9ec3ff'});
        add('line',{x1:plateX+plateW+10,y1:plateY+ePix,x2:plateX+plateW+20,y2:plateY+ePix,stroke:'#9ec3ff'});
        label(plateX+plateW+28, plateY+ePix/2+5, `e`, {anchor:'start', fill:'#9ec3ff'});

      } else if(roofType==='mono'){
        // рисуем наклон: верхняя кромка справа (если flow up — ветер снизу вверх к высокой кромке)
        const tilt = clamp(alpha,0,40);
        const dy = tilt/40 * 40; // визуальный наклон
        const poly = add('polygon',{fill:'rgba(255,255,255,0.04)',stroke:'#7aa2ff'},svg);
        const pts = [
          [plateX, plateY+plateH-dy],
          [plateX+plateW, plateY+plateH],
          [plateX+plateW, plateY+plateH],
          [plateX, plateY+plateH-dy]
        ];
        poly.setAttribute('points', pts.map(p=>p.join(',')).join(' '));
        // зоны F/G/H по высоте
        const ePix = clamp(e / Math.max(b,1) * plateH * 0.6, 12, plateH*0.35);
        add('rect',{x:plateX,y:plateY,width:plateW, height: ePix, fill:'rgba(255,255,255,0.06)', stroke:'#7aa2ff'});
        label(plateX+30, plateY+ePix/2+5, 'F', {size:16});
        add('rect',{x:plateX,y:plateY+ePix,width:plateW, height: ePix, fill:'rgba(255,255,255,0.05)', stroke:'#7aa2ff','stroke-dasharray':'4,4'});
        label(plateX+30, plateY+ePix+ePix/2+5, 'G', {size:16});
        add('rect',{x:plateX,y:plateY+2*ePix,width:plateW, height: plateH-2*ePix, fill:'rgba(255,255,255,0.03)', stroke:'#7aa2ff','stroke-dasharray':'2,6'});
        label(plateX+30, plateY+2*ePix+(plateH-2*ePix)/2+5, 'H', {size:16});

        // стрелка вдоль ската
        const dirText = (flowDir==='up')?'вверх ската':'вниз ската';
        add('line',{x1:plateX+plateW-200,y1:plateY+plateH-10-dy,x2:plateX+plateW-60,y2:plateY+plateH-10,stroke:'#8ab4ff','stroke-width':2,'marker-end':'url(#arrow)'});
        label(plateX+plateW-130, plateY+plateH-25-dy/2, dirText, {size:12, fill:'#8ab4ff'});

        // размер e
        add('line',{x1:plateX+plateW+15,y1:plateY,x2:plateX+plateW+15,y2:plateY+ePix,stroke:'#9ec3ff','stroke-width':2});
        add('line',{x1:plateX+plateW+10,y1:plateY,x2:plateX+plateW+20,y2:plateY,stroke:'#9ec3ff'});
        add('line',{x1:plateX+plateW+10,y1:plateY+ePix,x2:plateX+plateW+20,y2:plateY+ePix,stroke:'#9ec3ff'});
        label(plateX+plateW+28, plateY+ePix/2+5, `e`, {anchor:'start', fill:'#9ec3ff'});

      } else { // gable
        // двускатная: вершина по центру
        const ridgeY = plateY + plateH*0.35;
        const ridgeX = plateX + plateW/2;
        add('polygon',{points:`${plateX},${plateY+plateH} ${ridgeX},${ridgeY} ${plateX+plateW},${plateY+plateH}`, fill:'rgba(255,255,255,0.04)', stroke:'#7aa2ff'});

        // зоны: F/G/H/I (θ=90) либо F/G/H/I (θ=0) — просто подписи
        const zoneY = plateY + 20;
        label(plateX+30, zoneY, 'F', {size:16});
        label(plateX+plateW/3, zoneY, 'G', {size:16});
        label(plateX+2*plateW/3, zoneY, 'H', {size:16});
        label(plateX+plateW-30, zoneY, 'I', {size:16});

        // обозначение θ
        label(plateX+plateW-60, plateY+plateH-10, `θ=${$('#theta').value}°`, {anchor:'end', size:12, fill:'#9ec3ff'});

        // e
        const ePix = clamp(e / Math.max(b,1) * plateH * 0.6, 12, plateH*0.35);
        add('line',{x1:plateX+plateW+15,y1:plateY,x2:plateX+plateW+15,y2:plateY+ePix,stroke:'#9ec3ff','stroke-width':2});
        add('line',{x1:plateX+plateW+10,y1:plateY,x2:plateX+plateW+20,y2:plateY,stroke:'#9ec3ff'});
        add('line',{x1:plateX+plateW+10,y1:plateY+ePix,x2:plateX+plateW+20,y2:plateY+ePix,stroke:'#9ec3ff'});
        label(plateX+plateW+28, plateY+ePix/2+5, `e`, {anchor:'start', fill:'#9ec3ff'});
      }
    }

    // ===== Основной расчёт
    function buildTable(title,note,rows){
      const thead = `<thead>
        <tr>
          <th>Зона</th>
          <th>Описание</th>
          <th>c<sup>top</sup></th>
          <th>c<sup>bot</sup></th>
          <th>c<sub>net</sub>=top−bot</th>
          <th>w<sub>net</sub>=c<sub>net</sub>·q<sub>p</sub>·(c<sub>s</sub>c<sub>d</sub>)</th>
        </tr>
      </thead>`;
      const desc = (z)=>({
        F:'Кромка (F)',
        G:'Краевые (G)',
        H:'Центр (H)',
        I:'Подветренная половина (I)'
      }[z] || `Зона ${z}`);
      const tbody = `<tbody>${
        rows.map(r => `<tr>
          <td><b>${r.zone}</b></td>
          <td style="text-align:left">${desc(r.zone)}</td>
          <td>${fmt(r.cTop,2)}</td>
          <td>${fmt(r.cBot,2)}</td>
          <td>${fmt(r.cNet,2)}</td>
          <td>${fmt(r.wnet,0)}</td>
        </tr>`).join('')
      }</tbody>`;
      return `<div class="card" style="margin-top:12px"><div class="hd"><h2>${title}</h2><span class="pill">${note}</span></div><div class="bd"><table>${thead+tbody}</table></div></div>`;
    }

    function getCscd(apply){
      const m=$('#cscdMode').value;
      if(!apply) return 1.0;
      if(m==='manual') return Math.max(0.5, parseFloat($('#cscd').value)||1);
      return 1.0;
    }

    function headerReport(ctx){
      const {b,L,H,roofType,alpha,flowDir,theta,region,vb0,cdir,cseason,terrain,z0,zmin,co,ze,rho,ki,vb,ext,mode,cscd,A,e}=ctx;
      const lines=[];
      lines.push('— ВХОДНЫЕ ДАННЫЕ —');
      lines.push(`Геометрия: b=${fmt(b,2)} м; L=${fmt(L,2)} м; h=${fmt(H,2)} м; e=${fmt(e,2)} м`);
      const rt = roofType==='flat'?'плоский':(roofType==='mono'?`односкатный (α=${fmt(alpha,1)}°; ${flowDir==='up'?'ветер вверх ската':'ветер вниз ската'})`:`двускатный (α=${fmt(alpha,1)}°, θ=${theta}°)`);
      lines.push(`Тип: ${rt}`);
      lines.push(`Регион=${region}; v_b,0=${fmt(vb0,1)} м/с; c_dir=${fmt(cdir,2)}; c_season=${fmt(cseason,2)}; v_b=${fmt(vb,2)} м/с`);
      lines.push(`Местность: ${terrain} → z₀=${z0} м; z_min=${zmin} м; cₒ=${fmt(co,2)}; ρ=${fmt(rho,2)}; k_i=${fmt(ki,2)}`);
      lines.push(`z_e=${fmt(ze,2)} м; A=${fmt(A,2)} м²; режим: ${mode}; c_s c_d=${fmt(cscd,2)}`);
      lines.push('\n— ПРОФИЛЬ СКОРОСТИ И ПИКОВОЕ ДАВЛЕНИЕ —');
      lines.push(`c_r(z_e)=${fmt(cr(ze,z0),4)}; v_m=c_r·cₒ·v_b=${fmt(ext.vm,3)} м/с; I_v=${fmt(ext.iv,4)}; q_p=0.5·ρ·v_m²·(1+7I_v)=${fmt(ext.qp,0)} Па`);
      return lines;
    }

    function rowsReport(title, rows, qp, cscd){
      const lines=[`\n— ${title} —`];
      rows.forEach(r=>{
        lines.push(`\nЗона ${r.zone}: c_top=${fmt(r.cTop,2)}, c_bot=${fmt(r.cBot,2)}, c_net=${fmt(r.cNet,2)}`);
        lines.push(`w_net = c_net · q_p · (c_s c_d) = ${fmt(r.cNet,2)} · ${fmt(qp,0)} · ${fmt(cscd,2)} = ${fmt(r.wnet,0)} Па`);
      });
      return lines;
    }

    function calc(){
      // Геометрия / тип
      const b=parseFloat($('#b').value);
      const L=parseFloat($('#L').value);
      const H=parseFloat($('#H').value);
      const roofType=$('#roofType').value;
      const alpha=parseFloat($('#alpha').value||'0');
      const flowDir=$('#flowDir').value;
      const theta=$('#theta').value;

      // Климат / скорость
      const region=$('#region').value; const [rI,rII,rIII]=parseList($('#regionsMap').value,3);
      if(region!=='custom'){ const map={I:rI, II:rII, III:rIII}; $('#vb0').value = map[region] ?? $('#vb0').value }
      const vb0=parseFloat($('#vb0').value); const cdir=parseFloat($('#cdir').value); const cseason=parseFloat($('#cseason').value);

      const terrain=$('#terrain').value; const co=parseFloat($('#co').value);
      const rho=Math.max(0.5, parseFloat($('#rho').value)||RHO_DEF);
      const ki=Math.max(0.5, parseFloat($('#ki').value)||1);

      const z0=Z0_MAP[terrain]; const zmin=ZMIN_MAP[terrain];
      const zeMode=$('#zeMode')?.value||'auto';
      const zeRaw=zeMode==='manual'?parseFloat($('#zeExt').value):H;
      const ze=Math.max(zeRaw,zmin);

      const vb=cdir*cseason*vb0;
      const ext=peakPressure(rho, vb, ze, z0, co, ki);

      // KPI
      $('#kpi-vb0').textContent = fmt(vb0,1)+' м/с';
      $('#kpi-vb').textContent  = fmt(vb,1)+' м/с';
      $('#kpi-iv').textContent  = fmt(ext.iv,3);
      $('#kpi-qp').textContent  = fmt(ext.qp,0);

      const mode=$('#mode').value;
      const cscd=getCscd(mode==='mwfrs');
      const Aelem = Math.max(0.01, parseFloat($('#Aelem').value)||10);
      const e = eRoof(b,H);

      // Коэф. в зависимости от типа
      let Z=[], TOP=[], BOT=[];
      if(roofType==='flat'){
        const s=setsFlat(Aelem); Z=s.zones; TOP=s.top; BOT=s.bot;
      } else if(roofType==='mono'){
        const s=setsMono(Aelem, alpha, flowDir); Z=s.zones; TOP=s.top; BOT=s.bot;
      } else {
        const s=setsGable(Aelem, alpha, $('#theta').value); Z=s.zones; TOP=s.top; BOT=s.bot;
      }

      // Строки
      const rows = Z.map((zn,i)=>{
        const cTop=TOP[i], cBot=BOT[i];
        const cNet=cTop-cBot;              // чистое давление панели = верх − низ
        const wnet=cNet*ext.qp*cscd;       // знак «+» — вниз на панель
        return {zone:zn, cTop, cBot, cNet, wnet};
      });

      // Рендер таблицы
      const casesEl=$('#cases'); casesEl.innerHTML='';
      const title = (roofType==='flat') ? 'Плоский навес'
                  : (roofType==='mono') ? `Односкатный — ветер ${flowDir==='up'?'вверх ската':'вниз ската'}`
                  : `Двускатный — θ=${$('#theta').value}°`;
      casesEl.insertAdjacentHTML('beforeend',
        buildTable(title, `e=${fmt(e,2)} м; A=${fmt(Aelem,2)} м²`, rows)
      );

      // Легенда
      const leg=$('#legend');
      leg.innerHTML = (roofType==='flat')
        ? `<div class="item">Плоский: зоны <b>F</b> — кромка; <b>G</b> — краевые; <b>H</b> — центр. Нагрузка: (c_top−c_bot)·q_p.</div>`
        : (roofType==='mono')
        ? `<div class="item">Односкатный: <b>F</b> кромка; <b>G</b> краевые; <b>H</b> центр. Направление: ${flowDir==='up'?'снизу-вверх':'сверху-вниз'} по скату.</div>`
        : `<div class="item">Двускатный: θ=${$('#theta').value}°. Зоны <b>F/G/H/I</b>. Нагрузка: (c_top−c_bot)·q_p.</div>`;

      // Обновить схему
      drawScheme();

      // Отчёт
      const ctx={b,L,H,roofType,alpha,flowDir,theta,region,vb0,cdir,cseason,terrain,z0,zmin,co,ze,rho,ki,vb,ext,mode,cscd,A:Aelem,e};
      const lines=[...headerReport(ctx), ...rowsReport('Покрытие (зоны)', rows, ext.qp, cscd)];
      if($('#frictionOn').checked){
        const cfr = Math.max(0, parseFloat($('#cfr').value)||0.02);
        const tau = cfr * ext.qp;
        const F = tau * b * L;
        lines.push(`\n— ТРЕНИЕ (оценка) —`);
        lines.push(`τ = c_fr · q_p = ${fmt(cfr,3)} · ${fmt(ext.qp,0)} = ${fmt(tau,0)} Па; F ≈ τ · (b·L) = ${fmt(F,0)} Н`);
      }
      lines.push('\nПримечание: подставьте табличные c_pe^top / c_pe^bot из вашей редакции СН для навесов (свободных крыш).');
      $('#report').textContent = lines.join('\n');
    }

    // ===== События UI
    function toggleRows(){
      const rt=$('#roofType').value;
      $('#slopeRow').style.display = (rt==='flat') ? 'none' : '';
      $('#flowDirWrap').style.display = (rt==='mono') ? '' : 'none';
      $('#thetaRow').style.display = (rt==='gable') ? '' : 'none';
    }

    $('#btn-calc').addEventListener('click', calc);
    $('#btn-print').addEventListener('click', ()=> window.print());
    $('#btn-copy').addEventListener('click', ()=>{ const t=$('#report').innerText.trim(); if(!t) return; navigator.clipboard.writeText(t) });

    $('#roofType').addEventListener('change', ()=>{ toggleRows(); calc(); });
    $('#zeMode')?.addEventListener('change', e=>{ $('#zeManualRow').style.display = e.target.value==='manual' ? '' : 'none'; calc(); });

    let t; document.querySelectorAll('.bd input, .bd select').forEach(el=> el.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(calc,150) }));

    window.addEventListener('load', ()=>{ toggleRows(); calc(); });
  </script>
</body>
</html>
