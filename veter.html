<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор ветровой нагрузки · СН 2.01.05-2019 (FULL + авто cpi, интерполяция по A)</title>
  <meta name="description" content="Калькулятор ветровых нагрузок по СН 2.01.05-2019: стены и кровля, два направления ветра, учёт cscd/cpi, интерполяция cpe по площади элемента. Подробный отчёт с формулами — только при печати/PDF.">
  <style>
    :root{
      --bg:#0b1020; --card:#111730; --ink:#eaf1ff; --muted:#b7c4e0; --line:#263166; --acc:#8ab4ff;
      --radius:16px; --shadow:0 8px 22px rgba(0,0,0,.35);
      --col-left:420px;          /* уже левая колонка */
      --gap:16px;                /* чуть компактнее */
      --max:1500px               /* шире общий кадр */
    }
    *{box-sizing:border-box}
    html,body{height:100%; overflow-x:hidden} /* фикс горизонтального переполнения */
    body{margin:0; font-family:Inter,system-ui,Arial,sans-serif; background:var(--bg); color:var(--ink)}
    .container{max-width:var(--max); margin:auto; padding:14px 14px} /* меньше боковые отступы */
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    h1{margin:0; font-size:22px}
    .badge{font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:8px}
    button{appearance:none; border:1px solid var(--line); background:#1a2340; color:var(--ink); padding:10px 14px; border-radius:10px; cursor:pointer}
    button:hover{background:#213058}

    .grid{
      display:grid;
      grid-template-columns: minmax(0,var(--col-left)) minmax(0,1.5fr); /* шире правая колонка */
      gap:var(--gap); margin-top:14px
    }
    @media (max-width: 1000px){ .grid{grid-template-columns: 1fr} }

    .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); margin-bottom:16px; box-shadow:var(--shadow)}
    .card h2{margin:0; padding:12px 16px; border-bottom:1px solid rgba(255,255,255,.08)}
    .card .bd{padding:14px} /* компактнее внутренние поля */

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:640px){ .row{grid-template-columns:1fr} }

    /* не позволяем контенту распирать колонки */
    .card, .bd, .row > * { min-width:0 }

    label{font-size:12px; color:var(--muted); display:block; margin:4px 0}
    input, select, textarea{width:100%; padding:10px 12px; border-radius:10px; background:#0f1532; color:var(--ink); border:1px solid #2a3564; outline:none}
    input:focus, select:focus, textarea:focus{border-color:#3b55b9; box-shadow:0 0 0 3px rgba(138,180,255,.18)}
    .hint{font-size:11px; color:var(--muted); margin-top:6px; line-height:1.45}

    table{width:100%; border-collapse:collapse; font-size:14px; table-layout:fixed} /* цифры крупнее */
    th,td{padding:7px; border-bottom:1px dashed rgba(255,255,255,.08); text-align:right; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    th:first-child, td:first-child{text-align:left}
    #results table th, #results table td{
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }

    .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:#16203a; border:1px solid var(--line); font-size:12px}
    .legend{display:grid; gap:6px; margin-bottom:6px}
    .legend .item{font-size:12px; color:var(--muted)}

    .kpi{display:grid; grid-template-columns: repeat(4,1fr); gap:10px}
    @media (max-width:900px){ .kpi{grid-template-columns: repeat(2,1fr)} }
    .kpi .itm{background:#0f1532; border:1px solid #2a3564; border-radius:12px; padding:10px}
    .kpi .v{font-size:20px; font-weight:700} /* крупнее цифры KPI */
    .kpi .t{font-size:12px; color:var(--muted)}

    /* Справки */
    details.help{margin-top:8px; border:1px dashed rgba(255,255,255,.16); border-radius:10px; background:#0e1735}
    details.help[open]{background:#0e183b}
    details.help>summary{cursor:pointer; padding:8px 10px; color:var(--acc); list-style:none}
    details.help>summary::-webkit-details-marker{display:none}
    details.help .help-body{padding:0 12px 10px 12px; color:var(--muted); font-size:12px; line-height:1.5}
    .help-grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    @media (max-width:640px){ .help-grid{grid-template-columns:1fr} }
    .kbd{display:inline-block; border:1px solid #2a3564; border-radius:6px; padding:0 6px; font-size:11px; background:#0f1532}

    /* Печать */
    .print-only{display:none}
    @media print{
      .print-only{display:block}
      button,header,.floatbar,details.help{display:none!important}
      body{background:#fff;color:#000}
      .card{background:#fff;border:1px solid #ccc;box-shadow:none}
      .report{white-space:pre-wrap; font-family:Consolas, monospace; font-size:12px; line-height:1.45}
    }
  </style>
</head>
<body>
  <div class="container">
    <header style="margin-bottom:6px">
      <div>
        <h1>Калькулятор ветровой нагрузки</h1>
        <div class="badge">СН 2.01.05-2019 / EN 1991-1-4 — авто c<sub>pi</sub>, интерполяция c<sub>pe</sub>(A)</div>
      </div>
      <div class="actions">
        <button id="btn-calc">Рассчитать</button>
        <button id="btn-print">Печать / PDF</button>
        <button id="btn-copy">Копия отчёта</button>
      </div>
    </header>

    <div class="grid">
      <!-- Левая панель: ввод -->
      <section class="card" aria-labelledby="inputs-h2">
        <h2 id="inputs-h2">Входные данные</h2>
        <div class="bd">
          <!-- Геометрия -->
          <div class="row">
            <div>
              <label>L, м (длина)</label>
              <input type="number" step="0.01" id="L" value="60">
              <div class="hint">Горизонтальный размер вдоль длинной стороны здания.</div>
            </div>
            <div>
              <label>B, м (ширина)</label>
              <input type="number" step="0.01" id="B" value="24">
              <div class="hint">Горизонтальный размер поперёк длинной стороны.</div>
            </div>
          </div>
          <div class="row">
            <div>
              <label>h, м (высота до карниза/аттика)</label>
              <input type="number" step="0.01" id="H" value="12">
            </div>
            <div>
              <label>Тип кровли</label>
              <select id="roofType"><option value="flat">Плоская</option><option value="gable">Двускатная</option></select>
              <div class="hint">Для двускатной укажите уклон α и направление к коньку θ.</div>
            </div>
          </div>
          <div class="row" id="slopeRow" style="display:none">
            <div>
              <label>Уклон α, °</label>
              <input type="number" step="0.5" id="slope" value="15">
            </div>
            <div>
              <label>Угол к коньку θ</label>
              <select id="theta"><option value="90" selected>90° (⊥ коньку)</option><option value="0">0° (∥ коньку)</option></select>
            </div>
          </div>

          <hr style="border:none; border-top:1px solid #223; margin:12px 0">

          <!-- Климат и коэффициенты -->
          <div class="row">
            <div>
              <label>Ветровой район / v<sub>b,0</sub>, м/с</label>
              <div class="row">
                <select id="region"><option value="custom">Вручную</option><option value="I">I</option><option value="II" selected>II</option><option value="III">III</option></select>
                <input type="number" step="0.1" id="vb0" value="24">
              </div>
            </div>
            <div>
              <label>c<sub>dir</sub> / c<sub>season</sub></label>
              <div class="row">
                <input type="number" step="0.01" id="cdir" value="1.0">
                <input type="number" step="0.01" id="cseason" value="1.0">
              </div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Категория местности</label>
              <select id="terrain"><option value="0">0 — вода/берег</option><option value="I">I — открытая</option><option value="II" selected>II — сельхоз</option><option value="III">III — пригород/лес</option><option value="IV">IV — центр города</option></select>
            </div>
            <div>
              <label>Ороография cₒ(z)</label>
              <input type="number" step="0.01" id="co" value="1.0">
            </div>
          </div>

          <div class="row">
            <div>
              <label>ρ, кг/м³</label>
              <input type="number" step="0.01" id="rho" value="1.25">
            </div>
            <div>
              <label>k<sub>i</sub> (коэф. турбулентности)</label>
              <input type="number" step="0.01" id="ki" value="1.00">
              <div class="hint">Участвует в I<sub>v</sub>(z).</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>c<sub>s</sub>c<sub>d</sub> (структурный фактор)</label>
              <div class="row">
                <select id="cscdMode">
                  <option value="1">Не учитывать (1.0)</option>
                  <option value="auto" selected>Авто (допустимо 1.0)</option>
                  <option value="manual">Задать вручную</option>
                </select>
                <input type="number" step="0.01" id="cscd" value="1.00">
              </div>
              <div class="hint">«Авто» — примем 1.00 для обычных низких зданий (упрощённо).</div>
            </div>
            <div>
              <label>Режим расчёта</label>
              <select id="mode"><option value="mwfrs" selected>Главная система (MWFRS)</option><option value="cladding">Ограждения/крепёж</option></select>
            </div>
          </div>

          <!-- Внутреннее давление -->
          <div class="row">
            <div>
              <label>Внутр. давление c<sub>pi</sub> — режим</label>
              <select id="cpiMode">
                <option value="autoNoDom" selected>Авто — нет доминирующей (худшее из +0.2/−0.3)</option>
                <option value="autoDom">Авто — доминирующая поверхность (ψ·|c<sub>pe,ref</sub>|)</option>
                <option value="manual">Вручную</option>
              </select>
            </div>
            <div id="cpiManualBox">
              <label>c<sub>pi</sub> (ручной), модуль</label>
              <input type="number" step="0.05" id="cpi" value="0.30">
            </div>
          </div>
          <div class="row" id="cpiDomBox" style="display:none">
            <div>
              <label>ψ (0.75 / 0.90)</label>
              <select id="cpiPsi"><option value="0.75" selected>0.75</option><option value="0.90">0.90</option></select>
            </div>
            <div>
              <label>Опорный |c<sub>pe,ref</sub>| для доминирующей</label>
              <input type="number" step="0.05" id="cpiCpeRef" value="0.90">
              <div class="hint">Прикидывается по зоне, где большие проёмы (обычно наветр. поверхность).</div>
            </div>
          </div>

          <!-- Площадь элемента -->
          <div class="row">
            <div>
              <label>Площадь элемента A (для ограждений), м²</label>
              <input type="number" step="0.1" id="Aelem" value="20">
              <div class="hint">Меньшая A → более неблагоприятные c<sub>pe</sub> (интерполяция лог по A).</div>
            </div>
            <div>
              <label>Интерполяция c<sub>pe</sub>(A) между 1 и 10 м²</label>
              <select id="areaInterp" >
                <option value="on" selected>Включена (логарифм)</option>
                <option value="off">Выкл. (без поправок)</option>
              </select>
            </div>
          </div>

          <details>
            <summary>Расширенные настройки</summary>
            <div class="bd" style="padding:10px 0 0">
              <div class="row">
                <div>
                  <label>Ширина краевых полос стен: e = min(0.2·b, 0.2·h)</label>
                  <input type="number" step="0.01" id="eFactor" value="0.2">
                </div>
                <div>
                  <label>Кровля: e = k·min(b, 2h); k</label>
                  <input type="number" step="0.01" id="eRoofFactor" value="0.2">
                </div>
              </div>

              <!-- БАЗОВЫЕ cpe ДЛЯ ≥10 м² И ДЛЯ 1 м² (для интерполяции) -->
              <details>
                <summary>c<sub>pe</sub> стен (значения для A=10 м² и A=1 м²)</summary>
                <div class="row">
                  <div>
                    <label>D (наветренная) — cpe10 / cpe1</label>
                    <input id="cpeWallWindward10" value="0.80" />
                    <input id="cpeWallWindward1"  value="0.80" />
                  </div>
                  <div>
                    <label>A/B/C (боковые) — cpe10 / cpe1</label>
                    <input id="cpeWallSide10" value="-0.70,-0.70,-0.70" />
                    <input id="cpeWallSide1"  value="-0.90,-0.90,-0.90" />
                  </div>
                </div>
                <div class="row">
                  <div>
                    <label>E (подветренная) — cpe10 / cpe1</label>
                    <input id="cpeWallLeeward10" value="-0.50" />
                    <input id="cpeWallLeeward1"  value="-0.60" />
                  </div>
                  <div><label class="hint">Если нет данных для A=1 м² — оставьте как для 10 м².</label></div>
                </div>
              </details>

              <details>
                <summary>c<sub>pe</sub> кровли (значения для A=10 м² и A=1 м²)</summary>
                <div class="row">
                  <div>
                    <label>Плоская: F,G,H — cpe10</label>
                    <input id="cpeFlat10" value="-1.5,-1.0,-0.7" />
                  </div>
                  <div>
                    <label>Плоская: F,G,H — cpe1</label>
                    <input id="cpeFlat1" value="-1.9,-1.3,-0.9" />
                  </div>
                </div>
                <div class="row">
                  <div>
                    <label>Двускатная θ=90° (α=15°): F,G,H,I — cpe10</label>
                    <input id="cpeGable15_10" value="-0.9,-0.7,-0.5,-0.3" />
                  </div>
                  <div>
                    <label>Двускатная θ=90° (α=15°): F,G,H,I — cpe1</label>
                    <input id="cpeGable15_1" value="-1.2,-1.0,-0.7,-0.5" />
                  </div>
                </div>
                <div class="row">
                  <div><label>θ=90° (α=30°) — cpe10</label><input id="cpeGable30_10" value="-1.1,-0.9,-0.6,-0.4" /></div>
                  <div><label>θ=90° (α=30°) — cpe1</label><input id="cpeGable30_1"  value="-1.4,-1.2,-0.8,-0.6" /></div>
                </div>
                <div class="row">
                  <div><label>θ=90° (α=45°) — cpe10</label><input id="cpeGable45_10" value="-1.3,-1.0,-0.7,-0.5" /></div>
                  <div><label>θ=90° (α=45°) — cpe1</label><input id="cpeGable45_1"  value="-1.6,-1.3,-0.9,-0.7" /></div>
                </div>
                <div class="row">
                  <div><label>θ=0° (α=15°): F,G,H,I,J — cpe10</label><input id="cpeGable0_15_10" value="0.2,-0.6,-0.9,-0.4,-0.3" /></div>
                  <div><label>θ=0° (α=15°): F,G,H,I,J — cpe1</label><input id="cpeGable0_15_1"  value="0.2,-0.9,-1.2,-0.6,-0.5" /></div>
                </div>
                <div class="row">
                  <div><label>θ=0° (α=30°) — cpe10</label><input id="cpeGable0_30_10" value="0.2,-0.7,-1.0,-0.5,-0.4" /></div>
                  <div><label>θ=0° (α=30°) — cpe1</label><input id="cpeGable0_30_1"  value="0.2,-1.0,-1.3,-0.7,-0.6" /></div>
                </div>
                <div class="hint">Для промежуточных уклонов — линейная интерполяция по α. При необходимости подправьте значения под вашу редакцию СН.</div>
              </details>

              <details>
                <summary>Карта ветровых районов (vb,0)</summary>
                <div class="row">
                  <div>
                    <label>vb,0 для I/II/III (м/с)</label>
                    <input id="regionsMap" value="22,24,26" />
                  </div>
                  <div><label class="hint">Эти значения подставляются при выборе района I/II/III.</label></div>
                </div>
              </details>

              <details>
                <summary>Высоты отсчёта z_e</summary>
                <div class="row">
                  <div>
                    <label>Режим</label>
                    <select id="zeMode"><option value="auto" selected>Авто (стены/кровля = h; внутр. = h)</option><option value="manual">Вручную</option></select>
                  </div>
                  <div></div>
                </div>
                <div class="row" id="zeManualRow" style="display:none">
                  <div><label>z_e,ext (внешнее), м</label><input type="number" step="0.1" id="zeExt" value="12"></div>
                  <div><label>z_e,int (внутреннее), м</label><input type="number" step="0.1" id="zeInt" value="12"></div>
                </div>
              </details>

              <details>
                <summary>Трение (доп.)</summary>
                <div class="row">
                  <div>
                    <label><input type="checkbox" id="frictionOn" /> Учитывать суммарное трение кровли</label>
                  </div>
                  <div>
                    <label>c<sub>fr</sub> (0.01/0.02/0.04)</label>
                    <input type="number" step="0.01" id="cfr" value="0.02">
                  </div>
                </div>
                <div class="hint">Добавляется в отчёт как суммарная сдвигающая сила на покрытие (оценочно).</div>
              </details>
            </div>
          </details>
        </div>
      </section>

      <!-- Правая панель: результаты -->
      <section class="card" aria-labelledby="results-h2">
        <h2 id="results-h2">Результаты</h2>
        <div class="bd" id="results">
          <div class="legend" id="legend"></div>

          <div class="kpi">
            <div class="itm"><div class="t">vb,0</div><div class="v" id="kpi-vb0">—</div></div>
            <div class="itm"><div class="t">vb</div><div class="v" id="kpi-vb">—</div></div>
            <div class="itm"><div class="t">Iv(h)</div><div class="v" id="kpi-iv">—</div></div>
            <div class="itm"><div class="t">qp(h), Па</div><div class="v" id="kpi-qp">—</div></div>
          </div>

          <div style="height:10px"></div>
          <div id="cases"></div>

          <div class="print-only" style="margin-top:10px">
            <h2 style="margin:0 0 6px">Подробный отчёт (формулы)</h2>
            <div id="report" class="report">—</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ===== Константы
    const Z0_MAP={"0":0.003,"I":0.01,"II":0.05,"III":0.3,"IV":1.0};
    const ZMIN_MAP={"0":1,"I":1,"II":2,"III":5,"IV":10};
    const RHO_DEF=1.25;

    // ===== Утилиты
    const clamp=(v,min,max)=>Math.min(Math.max(v,min),max);
    const fmt=(v,d=2)=>Number.isFinite(v)?Number(v).toFixed(d):'—';
    const $=s=>document.querySelector(s);
    function parseList(str,expect){ const arr=String(str).split(/[,;\s]+/).filter(Boolean).map(Number); while(arr.length<expect) arr.push(arr[arr.length-1] ?? 0); return arr.slice(0,expect); }
    const log10=(x)=>Math.log(x)/Math.log(10);

    // ===== Профиль скорости / qp
    function kCoef(z0){return 0.19*Math.pow(z0/0.05,0.07)}
    function cr(z,z0){ const zc=Math.max(z, 1.0001*z0); return kCoef(z0)*Math.log(zc/z0); }
    function Iv(z,z0,co=1,ki=1){ const zc=Math.max(z, 1.0001*z0); return (ki*co/Math.log(zc/z0)) * Math.pow(z0/0.05, 0.07); }
    function peakPressure(rho, vb, z, z0, co, ki=1){ const vm = cr(z,z0) * (co||1) * vb; const iv = Iv(z,z0, co||1, ki); const qp = 0.5 * rho * vm * vm * (1 + 7*iv); return { vm, iv, qp }; }

    // ===== Геометрия зон
    function zonesForWalls(L,B,H, eFactor, caseType){ const along=caseType==='long'?B:L; const across=caseType==='long'?L:B; const e=Math.min(eFactor*along, eFactor*H); return { e, along, across } }
    function eRoofFor(caseType, L, B, H){ const b=(caseType==='long')?B:L; const k=parseFloat($('#eRoofFactor').value)||0.2; return k * Math.min(b, 2*H); }

    // ===== Наименования зон
    function wallZoneDesc(z){ const map={A:'Боковая стена — полоса A',B:'Боковая стена — полоса B',C:'Боковая стена — полоса C',D:'Наветренная стена (D)',E:'Подветренная стена (E)'}; return map[z]||`Зона ${z}`; }
    function roofZoneDesc(z, roofType, theta){
      if(roofType==='flat'){
        const mapF={F:'Плоская кровля — наветренная кромка (F)', G:'Плоская кровля — боковые/подветренная (G)', H:'Плоская кровля — центральная зона (H)'}; return mapF[z]||`Зона ${z}`;
      } else if(Number(theta)===90){
        const map90={F:'Двускатная θ=90° — краевая наветренного (F)', G:'Двускатная θ=90° — краевая подветренного/боковых (G)', H:'Двускатная θ=90° — средняя наветренного (H)', I:'Двускатная θ=90° — средняя подветренного (I)'}; return map90[z]||`Зона ${z}`;
      } else {
        const map0={F:'Двускатная θ=0° — фронтонная наветренная кромка (F)', G:'Двускатная θ=0° — продольные краевые (G)', H:'Двускатная θ=0° — центр наветренного (H)', I:'Двускатная θ=0° — центр подветренного (I)', J:'Двускатная θ=0° — у конька/кромки (J)'}; return map0[z]||`Зона ${z}`;
      }
    }

    // ===== Помощники по cpe(A)
    function cpeAreaInterp(cpe10, cpe1, A){
      if($('#areaInterp').value==='off') return cpe10;
      if(!(A>0)) return cpe10;
      if(A<=1) return cpe1;
      if(A>=10) return cpe10;
      return cpe1 - (cpe1 - cpe10)*log10(A); // логарифмическая интерполяция
    }

    // ===== c_pi режимы
    function getCpiAbs(){
      const m=$('#cpiMode').value;
      if(m==='manual') return Math.abs(parseFloat($('#cpi').value)||0);
      if(m==='autoNoDom'){ // худшее из +0.2 и −0.3 → модуль 0.30 (знак учитываем в таблицах)
        return 0.30;
      }
      // доминирующая поверхность: c_pi = ψ * |c_pe,ref|
      const psi=parseFloat($('#cpiPsi').value)||0.75;
      const cpeRef=Math.abs(parseFloat($('#cpiCpeRef').value)||0.9);
      return psi*cpeRef;
    }

    function getCscd(apply){
      const m=$('#cscdMode').value;
      if(!apply) return 1.0;
      if(m==='manual') return Math.max(0.5, parseFloat($('#cscd').value)||1);
      // auto и "1" — примем 1.0 в упрощённом режиме
      return 1.0;
    }

    // ===== Построение таблиц
    function buildTable(title,note,rows, ctx){
      const thead = `<thead>
        <tr>
          <th>Зона</th>
          <th>Описание</th>
          <th>c<sub>pe</sub>(A)</th>
          <th>w<sub>e</sub>=c<sub>pe</sub>·q<sub>p,ext</sub>·(c<sub>s</sub>c<sub>d</sub>)</th>
          <th>w<sub>net,+</sub>=w<sub>e</sub>+c<sub>pi</sub>·q<sub>p,int</sub></th>
          <th>w<sub>net,−</sub>=w<sub>e</sub>−c<sub>pi</sub>·q<sub>p,int</sub></th>
        </tr>
      </thead>`;
      const descFor = (z)=> ctx?.kind==='wall' ? wallZoneDesc(z) : roofZoneDesc(z, ctx?.roofType, ctx?.theta);
      const tbody = `<tbody>${
        rows.map(r => `<tr>
          <td><b>${r.zone}</b></td>
          <td style="text-align:left">${descFor(r.zone)}</td>
          <td>${fmt(r.cpeEff,2)}</td>
          <td>${fmt(r.we,0)}</td>
          <td>${fmt(r.wplus,0)}</td>
          <td>${fmt(r.wminus,0)}</td>
        </tr>`).join('')
      }</tbody>`;
      return `<div class="card" style="margin-top:12px"><div class="hd"><h2>${title}</h2><span class="pill">${note}</span></div><div class="bd"><table>${thead+tbody}</table></div></div>`;
    }

    function buildCaseBlock(name, wallData, roofData, ctx){
      return `<div class="card" style="margin-top:12px">
        <div class="hd"><h2>${name}</h2><span class="pill">Стены: e=${fmt(wallData.e,2)} м, фронт=${fmt(wallData.across,2)} м</span></div>
        <div class="bd">
          <div class="row">
            <div>${buildTable('Наветренная стена','D', wallData.windward, {kind:'wall'})}</div>
            <div>${buildTable('Боковые стены','A/B/C', wallData.side, {kind:'wall'})}</div>
          </div>
          <div style="height:8px"></div>
          <div>${buildTable('Подветренная стена','E', wallData.leeward, {kind:'wall'})}</div>
          <div style="height:8px"></div>
          <div>${buildTable(roofData.title, roofData.note, roofData.rows, {kind:'roof', roofType:ctx.roofType, theta:ctx.theta})}</div>
        </div>
      </div>`;
    }

    // ===== Отчёт
    function headerReport(ctx){
      const {L,B,H,roofType,slope,theta,region,vb0,cdir,cseason,terrain,z0,zmin,co,zeExt,zeInt,rho,ki,vb,ext,intp,mode}=ctx;
      const lines=[];
      lines.push('— ВХОДНЫЕ ДАННЫЕ —');
      lines.push(`Геометрия: L=${fmt(L,2)} м; B=${fmt(B,2)} м; h=${fmt(H,2)} м; кровля=${roofType==='flat'?'плоская':`двускатная (α=${fmt(slope,1)}°, θ=${theta}°)`}`);
      lines.push(`Регион=${region}; v_b,0=${fmt(vb0,1)} м/с; c_dir=${fmt(cdir,2)}; c_season=${fmt(cseason,2)}`);
      lines.push(`v_b = ${fmt(vb0,1)} · ${fmt(cdir,2)} · ${fmt(cseason,2)} = ${fmt(vb,2)} м/с`);
      lines.push(`Местность: ${terrain} → z₀=${z0} м; z_min=${zmin} м; cₒ(z)=${fmt(co,2)}; ρ=${fmt(rho,2)} кг/м³; k_i=${fmt(ki,2)}`);
      lines.push(`z_e,ext=${fmt(zeExt,2)} м; z_e,int=${fmt(zeInt,2)} м`);

      lines.push('\n— ПРОФИЛЬ СКОРОСТИ И ПИКОВОЕ ДАВЛЕНИЕ —');
      const k=kCoef(z0);
      lines.push(`k_r = 0.19 · (z₀ / 0.05)^0.07 = ${fmt(k,4)}`);
      lines.push(`c_r(z_e,ext) = ${fmt(cr(zeExt,z0),4)}; v_m(ext) = c_r·cₒ·v_b = ${fmt(cr(zeExt,z0),4)} · ${fmt(co,2)} · ${fmt(vb,2)} = ${fmt(ext.vm,3)} м/с`);
      lines.push(`I_v(ext) = (k_i·cₒ)/ln(z_e/z₀)·(z₀/0.05)^0.07 = ${fmt(ext.iv,4)}`);
      lines.push(`q_p(ext) = 0.5·ρ·v_m²·(1+7I_v) = ${fmt(ext.qp,0)} Па`);
      lines.push(`c_r(z_e,int) = ${fmt(cr(zeInt,z0),4)}; v_m(int) = ${fmt(intp.vm,3)} м/с; I_v(int) = ${fmt(intp.iv,4)}; q_p(int) = ${fmt(intp.qp,0)} Па`);

      lines.push('\n— ПАРАМЕТРЫ РЕЖИМА —');
      const cpiTxt=(function(){
        const m=$('#cpiMode').value;
        if(m==='manual') return `c_pi = ${fmt(Math.abs(parseFloat($('#cpi').value)||0),2)}`;
        if(m==='autoNoDom') return 'c_pi = ±0.20 / ±0.30 (в отчёте показаны обе комбинации, в таблицах — модуль 0.30)';
        return `c_pi = ψ·|c_pe,ref| = ${fmt(parseFloat($('#cpiPsi').value)||0.75,2)}·${fmt(Math.abs(parseFloat($('#cpiCpeRef').value)||0.9),2)} = ${fmt(getCpiAbs(),2)}`;
      })();
      lines.push(`Режим: ${($('#mode').value==='mwfrs')?'MWFRS (учёт c_s c_d)':'Cladding (локальные давления)'}`);
      lines.push(`Внутреннее давление: ${cpiTxt}`);
      const cscdTxt = ($('#mode').value==='mwfrs')?`c_s c_d = ${fmt(getCscd(true),2)} (упрощённо)`:'c_s c_d = 1.00 (не учитывается)';
      lines.push(cscdTxt);
      if($('#frictionOn').checked){
        lines.push(`Трение кровли: учтено с c_fr=${fmt(parseFloat($('#cfr').value)||0.02,2)} (суммарная сила добавляется ниже).`);
      }
      return lines;
    }

    function zoneReportDetailed(title, rows){
      const lines=[`\n— ${title} —`];
      rows.forEach(r=>{
        const desc = (['A','B','C','D','E'].includes(r.zone))
          ? wallZoneDesc(r.zone)
          : roofZoneDesc(r.zone, $('#roofType').value, $('#theta').value);
        lines.push(`\nЗона ${r.zone} — ${desc}`);
        lines.push(`1) c_pe(A) = ${fmt(r.cpeEff,2)} (интерполяция по A)`);
        lines.push(`2) w_e = c_pe · q_p,ext · (c_s c_d) = ${fmt(r.cpeEff,2)} · ${fmt(r.qpExt,0)} · ${fmt(r.cscd,2)} = ${fmt(r.we,0)} Па`);
        lines.push(`3) w_net,+ = w_e + c_pi·q_p,int = ${fmt(r.we,0)} + ${fmt(r.cpi,2)}·${fmt(r.qpInt,0)} = ${fmt(r.wplus,0)} Па`);
        lines.push(`   w_net,− = w_e − c_pi·q_p,int = ${fmt(r.we,0)} − ${fmt(r.cpi,2)}·${fmt(r.qpInt,0)} = ${fmt(r.wminus,0)} Па`);
      });
      return lines;
    }

    // ===== Основной расчёт
    function calc(){
      // Геометрия/кровля
      const L=parseFloat($('#L').value); const B=parseFloat($('#B').value); const H=parseFloat($('#H').value);
      const roofType=$('#roofType').value; const slope=parseFloat($('#slope').value||'0'); const theta=parseFloat($('#theta').value||'90');

      // Регион / скорость
      const region=$('#region').value; const [rI,rII,rIII]=parseList($('#regionsMap').value,3);
      if(region!=='custom'){ const map={I:rI, II:rII, III:rIII}; $('#vb0').value = map[region] ?? $('#vb0').value }
      const vb0=parseFloat($('#vb0').value); const cdir=parseFloat($('#cdir').value); const cseason=parseFloat($('#cseason').value);

      // Местность / плотность / высоты / коэффициенты
      const terrain=$('#terrain').value; const co=parseFloat($('#co').value);
      const rho=Math.max(0.5, parseFloat($('#rho').value)||RHO_DEF);
      const ki=Math.max(0.5, parseFloat($('#ki').value)||1);
      const eFactor=parseFloat($('#eFactor').value);
      const z0=Z0_MAP[terrain]; const zmin=ZMIN_MAP[terrain];
      const zeMode=$('#zeMode')?.value||'auto';
      const zeExtRaw=zeMode==='manual'?parseFloat($('#zeExt').value):H;
      const zeIntRaw=zeMode==='manual'?parseFloat($('#zeInt').value):H;
      const zeExt=Math.max(zeExtRaw,zmin); const zeInt=Math.max(zeIntRaw,zmin);

      // Базовая скорость и qp
      const vb=cdir*cseason*vb0;
      const ext=peakPressure(rho, vb, zeExt, z0, co, ki);
      const intp=peakPressure(rho, vb, zeInt, z0, co, ki);

      // KPI
      $('#kpi-vb0').textContent = fmt(vb0,1)+' м/с';
      $('#kpi-vb').textContent  = fmt(vb,1)+' м/с';
      $('#kpi-iv').textContent  = fmt(ext.iv,3);
      $('#kpi-qp').textContent  = fmt(ext.qp,0);

      const mode=$('#mode').value; const applyCscd=(mode==='mwfrs');
      const cpiAbs=getCpiAbs();
      const cscd = getCscd(applyCscd);
      const Aelem = Math.max(0.01, parseFloat($('#Aelem').value)||10);

      // Загрузка cpe таблиц (10 м² и 1 м²)
      const cpeWallWindward10 = parseList($('#cpeWallWindward10').value,1);
      const cpeWallWindward1  = parseList($('#cpeWallWindward1').value,1);
      const cpeWallSide10     = parseList($('#cpeWallSide10').value,3);
      const cpeWallSide1      = parseList($('#cpeWallSide1').value,3);
      const cpeWallLeeward10  = parseList($('#cpeWallLeeward10').value,1);
      const cpeWallLeeward1   = parseList($('#cpeWallLeeward1').value,1);

      const cpeFlat10 = parseList($('#cpeFlat10').value,3);
      const cpeFlat1  = parseList($('#cpeFlat1').value,3);

      const g15_10=parseList($('#cpeGable15_10').value,4), g15_1=parseList($('#cpeGable15_1').value,4);
      const g30_10=parseList($('#cpeGable30_10').value,4), g30_1=parseList($('#cpeGable30_1').value,4);
      const g45_10=parseList($('#cpeGable45_10').value,4), g45_1=parseList($('#cpeGable45_1').value,4);

      const g0_15_10=parseList($('#cpeGable0_15_10').value,5), g0_15_1=parseList($('#cpeGable0_15_1').value,5);
      const g0_30_10=parseList($('#cpeGable0_30_10').value,5), g0_30_1=parseList($('#cpeGable0_30_1').value,5);

      function cpeEffVal(c10,c1){ return cpeAreaInterp(c10,c1,Aelem); }

      function netRow(cpeEff){
        const we = cpeEff * ext.qp * cscd;
        const wplus  = we + cpiAbs*intp.qp;
        const wminus = we - cpiAbs*intp.qp;
        return { cpeEff, cscd, cpi:cpiAbs, qpExt:ext.qp, qpInt:intp.qp, we, wplus, wminus };
      }

      const casesEl=$('#cases'); casesEl.innerHTML='';

      function buildWalls(caseType){
        const z=zonesForWalls(L,B,H,eFactor,caseType);
        const wind=[{zone:'D', ...netRow(cpeEffVal(cpeWallWindward10[0], cpeWallWindward1[0]))}];
        const side=['A','B','C'].map((zn,i)=>({zone:zn, ...netRow(cpeEffVal(cpeWallSide10[i], cpeWallSide1[i]))}));
        const lee=[{zone:'E', ...netRow(cpeEffVal(cpeWallLeeward10[0], cpeWallLeeward1[0]))}];
        return { ...z, windward:wind, side, leeward:lee }
      }
      function interp(a,setA,aA,setB,aB){ const t=clamp((a-aA)/(aB-aA),0,1); return setA.map((v,i)=> v + (setB[i]-v)*t ) }

      function buildRoof(caseType){
        const eR=eRoofFor(caseType,L,B,H);
        if(roofType==='flat'){
          const rows=['F','G','H'].map((z,i)=>({zone:z, ...netRow(cpeEffVal(cpeFlat10[i], cpeFlat1[i]))}));
          return { title:'Покрытие (плоское)', note:`e=${fmt(eR,2)} м`, rows }
        } else {
          if(theta===90){
            const set10=(slope<=22.5)?interp(slope,g15_10,15,g30_10,30):interp(slope,g30_10,30,g45_10,45);
            const set1 =(slope<=22.5)?interp(slope,g15_1 ,15,g30_1 ,30):interp(slope,g30_1 ,30,g45_1 ,45);
            const rows=['F','G','H','I'].map((z,i)=>({zone:z, ...netRow(cpeEffVal(set10[i], set1[i]))}));
            return { title:`Покрытие (двускатное, θ=90°, α=${fmt(slope,1)}°)`, note:`e=${fmt(eR,2)} м`, rows }
          } else {
            const set10=(slope<=22.5)?g0_15_10:g0_30_10;
            const set1 =(slope<=22.5)?g0_15_1 :g0_30_1 ;
            const rows=['F','G','H','I','J'].map((z,i)=>({zone:z, ...netRow(cpeEffVal(set10[i], set1[i]))}));
            return { title:`Покрытие (двускатное, θ=0°, α=${fmt(slope,1)}°)`, note:`e=${fmt(eR,2)} м`, rows }
          }
        }
      }

      const wallsLong=buildWalls('long'); const wallsShort=buildWalls('short');
      const roofLong=buildRoof('long');  const roofShort=buildRoof('short');

      const ctx={roofType, theta};
      casesEl.insertAdjacentHTML('beforeend',
        buildCaseBlock('Случай A — ветер на длинную грань', wallsLong,  roofLong, ctx) +
        buildCaseBlock('Случай B — ветер на короткую грань', wallsShort, roofShort, ctx)
      );

      // Легенда
      updateLegend();

      // Отчёт
      const ctxRep={L,B,H,roofType,slope,theta,region,vb0,cdir,cseason,terrain,z0,zmin,co,zeExt,zeInt,rho,ki,vb,ext,intp,mode};
      const lines=[...headerReport(ctxRep)];
      lines.push('\n— СЛУЧАЙ A — ВЕТЕР НА ДЛИННУЮ ГРАНЬ —');
      lines.push(...zoneReportDetailed('Стены (A/B/C, D, E)', [].concat(wallsLong.windward,wallsLong.side,wallsLong.leeward)));
      lines.push(...zoneReportDetailed(roofLong.title, roofLong.rows));
      lines.push('\n— СЛУЧАЙ B — ВЕТЕР НА КОРОТКУЮ ГРАНЬ —');
      lines.push(...zoneReportDetailed('Стены (A/B/C, D, E)', [].concat(wallsShort.windward,wallsShort.side,wallsShort.leeward)));
      lines.push(...zoneReportDetailed(roofShort.title, roofShort.rows));

      // Трение (оценка суммарной силы на кровле)
      if($('#frictionOn').checked){
        const cfr = Math.max(0, parseFloat($('#cfr').value)||0.02);
        // простая оценка: τ = c_fr * q_p(ext) ; F = τ * A_roof; A_roof ~ L*B
        const tau = cfr * ext.qp;
        const F = tau * L * B;
        lines.push(`\n— ТРЕНИЕ КРОВЛИ (оценка) —`);
        lines.push(`τ = c_fr · q_p(ext) = ${fmt(cfr,3)} · ${fmt(ext.qp,0)} = ${fmt(tau,0)} Па; F ≈ τ · (L·B) = ${fmt(F,0)} Н`);
      }

      lines.push('\nПримечание: значения c_pe(10 м²)/c_pe(1 м²) можно откорректировать по вашей редакции СН 2.01.05-2019; для промежуточных площадей применяется логарифмическая интерполяция.');
      $('#report').textContent = lines.join('\n');
    }

    // ===== Динамическая легенда и UI-события
    function updateLegend(){
      const roofType=$('#roofType').value; const theta=parseFloat($('#theta').value||'90'); const el=$('#legend'); if(!el) return;
      if(roofType==='flat'){
        el.innerHTML=`<div class="item">Зоны стен: <b>D</b> — наветренная; <b>E</b> — подветренная; <b>A/B/C</b> — боковые полосы.</div>
                      <div class="item">Плоская кровля: <b>F</b> — наветренная кромка; <b>G</b> — боковые и подветренная; <b>H</b> — центр.</div>`;
      } else if(theta===90){
        el.innerHTML=`<div class="item">Зоны стен: <b>D</b> — наветренная; <b>E</b> — подветренная; <b>A/B/C</b> — боковые полосы.</div>
                      <div class="item">Двускатная (θ=90°): <b>F</b> — краевая наветренного; <b>G</b> — краевая подветренного/боковых; <b>H</b> — средняя наветренного; <b>I</b> — средняя подветренного.</div>`;
      } else {
        el.innerHTML=`<div class="item">Зоны стен: <b>D</b> — наветренная; <b>E</b> — подветренная; <b>A/B/C</b> — боковые полосы.</div>
                      <div class="item">Двускатная (θ=0°): <b>F</b> — фронтонная наветренная кромка; <b>G</b> — продольные краевые; <b>H</b> — центр наветренного; <b>I</b> — центр подветренного; <b>J</b> — у конька/кромки.</div>`;
      }
    }

    function toggleCpiBoxes(){
      const mode = $('#cpiMode').value;
      $('#cpiManualBox').style.display = (mode==='manual') ? '' : 'none';
      $('#cpiDomBox').style.display    = (mode==='autoDom') ? '' : 'none';
    }

    // ===== Служебные события
    $('#btn-calc').addEventListener('click', calc);
    $('#btn-print').addEventListener('click', ()=> window.print());
    $('#btn-copy').addEventListener('click', ()=>{ const t=$('#report').innerText.trim(); if(!t) return; navigator.clipboard.writeText(t) });

    $('#roofType').addEventListener('change', (e)=>{ $('#slopeRow').style.display = e.target.value==='gable' ? '' : 'none'; updateLegend(); calc(); });
    $('#theta').addEventListener('change', ()=>{ updateLegend(); calc(); });
    $('#zeMode')?.addEventListener('change', e=>{ $('#zeManualRow').style.display = e.target.value==='manual' ? '' : 'none'; calc(); });
    $('#cpiMode').addEventListener('change', ()=>{ toggleCpiBoxes(); calc(); });

    let t; document.querySelectorAll('.bd input, .bd select').forEach(el=> el.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(calc,150) }));

    window.addEventListener('load', ()=>{ updateLegend(); toggleCpiBoxes(); calc(); });
  </script>
</body>
</html>
