<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор ветровой нагрузки · СН 2.01.05‑2019 (FULL, без справки)</title>
  <meta name="description" content="Калькулятор ветровых нагрузок по СН 2.01.05‑2019: стены и кровля, два направления ветра, учёт cscd/cpi и площадей элементов. Подробный отчёт с формулами выводится только при печати/PDF. Подсказки под всеми полями." />
  <style>
    :root{ --bg:#0a0f1a; --card:#121826; --ink:#e7eefc; --muted:#9fb0d0; --line:#1e2740; --accent:#7aa2ff; --radius:16px; --shadow:0 8px 22px rgba(0,0,0,.35); --col-left:520px; --gap:18px; --max:1240px }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, system-ui, Roboto, Segoe UI, Arial, sans-serif; background:var(--bg); color:var(--ink)}
    .container{max-width:var(--max); margin:0 auto; padding:22px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .title{display:flex; align-items:center; gap:12px}
    .logo{width:38px; height:38px; background:#2b375a; border-radius:10px; display:grid; place-items:center}
    h1{margin:0; font-size:22px}
    .badge{font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:8px}
    .btn{appearance:none; border:1px solid var(--line); background:#1a2340; color:var(--ink); padding:10px 14px; border-radius:10px; cursor:pointer}
    .btn:hover{background:#213058}
    .btn.secondary{background:transparent}

    .grid{display:grid; grid-template-columns: var(--col-left) 1fr; gap:var(--gap); margin-top:14px}
    @media (max-width: 1000px){ .grid{grid-template-columns: 1fr} }

    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card .hd{padding:14px 14px 0}
    .card .bd{padding:14px}
    .card h2{margin:0 0 10px; font-size:16px}

    label{font-size:12px; color:var(--muted); display:block; margin:4px 0}
    input, select, textarea{width:100%; padding:10px 12px; border-radius:10px; background:#0f1528; color:var(--ink); border:1px solid var(--line); outline:none}
    input:focus, select:focus, textarea:focus{border-color:#2c4ec4; box-shadow:0 0 0 3px rgba(122,162,255,.18)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:640px){ .row{grid-template-columns:1fr} }

    .hint{font-size:11px; color:var(--muted); margin-top:6px; line-height:1.45}
    .hint code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:11px}

    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{padding:8px; border-bottom:1px dashed rgba(255,255,255,.08); text-align:right}
    th:first-child, td:first-child{text-align:left}

    .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:#16203a; border:1px solid var(--line); font-size:12px}
    .kpi{display:grid; grid-template-columns: repeat(4,1fr); gap:10px}
    @media (max-width:900px){ .kpi{grid-template-columns: repeat(2,1fr)} }
    .kpi .itm{background:#0f1528; border:1px solid var(--line); border-radius:12px; padding:10px}
    .kpi .v{font-size:18px; font-weight:700}
    .kpi .t{font-size:12px; color:var(--muted)}

    /* Отчёт скрыт на экране, виден только при печати */
    .print-only{display:none}
    @media print{
      body{background:#fff; color:#000}
      .card, .kpi .itm{background:#fff; border:1px solid #ddd; box-shadow:none}
      .actions, .btn, .floatbar{display:none !important}
      .report{white-space:pre-wrap; font-family:Consolas, monospace; font-size:12px; line-height:1.45; background:#fff; border:1px solid #ccc; border-radius:8px; padding:10px}
      .print-only{display:block}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <div class="logo">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 12a8 8 0 118 8V4a8 8 0 00-8 8z" fill="#7aa2ff"/></svg>
        </div>
        <div>
          <h1>Калькулятор ветровой нагрузки</h1>
          <div class="badge">СН 2.01.05‑2019 / EN 1991‑1‑4</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" data-action="calc">Рассчитать</button>
        <button class="btn secondary" data-action="print">Печать / PDF</button>
        <button class="btn secondary" data-action="copy">Копия отчёта</button>
      </div>
    </header>

    <div class="grid">
      <!-- Левая панель: ввод -->
      <section class="card" aria-labelledby="inputs-h2">
        <div class="hd"><h2 id="inputs-h2">Входные данные</h2></div>
        <div class="bd">
          <div class="row">
            <div>
              <label>L, м (длина)</label>
              <input type="number" step="0.01" id="L" value="60">
              <div class="hint">Горизонтальный размер вдоль длинной стороны здания.</div>
            </div>
            <div>
              <label>B, м (ширина)</label>
              <input type="number" step="0.01" id="B" value="24">
              <div class="hint">Горизонтальный размер вдоль короткой стороны (поперёк длинной).</div>
            </div>
          </div>
          <div class="row">
            <div>
              <label>h, м (высота до карниза/аттика)</label>
              <input type="number" step="0.01" id="H" value="12">
              <div class="hint">Расчётная высота здания до карниза/аттика (без учёта кровельных надстроек).</div>
            </div>
            <div>
              <label>Тип кровли</label>
              <select id="roofType">
                <option value="flat">Плоская</option>
                <option value="gable">Двускатная</option>
              </select>
              <div class="hint">Для двускатной укажите уклон <code>α</code> и направление ветра к коньку <code>θ</code>: 90° — ветер ⟂ коньку; 0° — ∥ коньку.</div>
            </div>
          </div>
          <div class="row" id="slopeRow" style="display:none">
            <div>
              <label>Уклон α, °</label>
              <input type="number" step="0.5" id="slope" value="15">
              <div class="hint">Угол ската к горизонту. Коэф. кровли интерполируются по <code>α</code>.</div>
            </div>
            <div>
              <label>Угол к коньку θ</label>
              <select id="theta">
                <option value="90" selected>90° (⊥ к коньку)</option>
                <option value="0">0° (∥ к коньку)</option>
              </select>
              <div class="hint">Относительное направление ветра к линии конька.</div>
            </div>
          </div>

          <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

          <div class="row">
            <div>
              <label>Ветровой район / vb,0, м/с</label>
              <div class="row">
                <select id="region">
                  <option value="custom">Вручную</option>
                  <option value="I">I</option>
                  <option value="II" selected>II</option>
                  <option value="III">III</option>
                </select>
                <input type="number" step="0.1" id="vb0" value="24">
              </div>
              <div class="hint">Выберите район (I/II/III) или введите базовую скорость <code>v_b,0</code> вручную. Значения районов редактируются ниже.</div>
            </div>
            <div>
              <label>cdir / cseason</label>
              <div class="row">
                <input type="number" step="0.01" id="cdir" value="1.0">
                <input type="number" step="0.01" id="cseason" value="1.0">
              </div>
              <div class="hint"><code>c_dir</code> — направленность (роза ветров); <code>c_season</code> — сезонность. Если нет специальных данных — оставьте 1.00.</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Категория местности</label>
              <select id="terrain">
                <option value="0">0 — вода/берег</option>
                <option value="I">I — открытая</option>
                <option value="II" selected>II — сельхоз</option>
                <option value="III">III — пригород/лес</option>
                <option value="IV">IV — центр города</option>
              </select>
              <div class="hint">Шероховатость подстилающей поверхности (задаёт <code>z₀</code> и <code>z_min</code>). Для равнинной незастроенной местности обычно II.</div>
            </div>
            <div>
              <label>Ороография cₒ(z)</label>
              <input type="number" step="0.01" id="co" value="1.0">
              <div class="hint"><code>cₒ(z)</code> учитывает ускорение потока на склонах/уступах. На ровной местности — 1.00.</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Внутр. давление c_pi</label>
              <div class="row">
                <select id="cpiMode">
                  <option value="autoSmall">Малая проницаемость (±0.2)</option>
                  <option value="autoMedium" selected>Средняя (±0.3)</option>
                  <option value="autoLarge">Большая (±0.5)</option>
                  <option value="manual">Вручную</option>
                </select>
                <input type="number" step="0.05" id="cpi" value="0.3">
              </div>
              <div class="hint">Автовыбор по проницаемости или ручной ввод по расчёту/отверстиям. В каждой зоне берётся неблагоприятный знак <code>±c_pi</code>.</div>
            </div>
            <div>
              <label>ρ, кг/м³</label>
              <input type="number" step="0.01" id="rho" value="1.25">
              <div class="hint">Плотность воздуха. Типично 1.25 кг/м³; корректируйте при нетипичных условиях.</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>c_s c_d (структурный фактор)</label>
              <div class="row">
                <select id="cscdMode">
                  <option value="1" selected>Не учитывать (1.0)</option>
                  <option value="manual">Задать вручную</option>
                </select>
                <input type="number" step="0.01" id="cscd" value="1.00">
              </div>
              <div class="hint"><code>c_s c_d</code> — порывистость и динамический отклик. Для жёстких низких зданий обычно 1.00. Для гибких/высотных задайте по динамическому расчёту.</div>
            </div>
            <div>
              <label>Режим</label>
              <select id="mode">
                <option value="mwfrs" selected>Главная система (MWFRS)</option>
                <option value="cladding">Ограждения/крепёж</option>
              </select>
              <div class="hint">MWFRS — нагрузки на несущую систему. «Ограждения» — локальные давления на панели/крепёж (с поправками для малых площадей).</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Площадь элемента A (для ограждений), м²</label>
              <div class="row">
                <select id="areaClass">
                  <option value=">=10" selected>≥ 10 м²</option>
                  <option value="<=10">≤ 10 м²</option>
                  <option value="<=1">≤ 1 м²</option>
                </select>
                <input type="number" step="0.1" id="Aelem" value="20">
              </div>
              <div class="hint">Класс площади влияет на локальные <code>c_pe</code>. Чем меньше элемент, тем неблагоприятнее давления (уточняйте по таблицам СН).</div>
            </div>
            <div>
              <label>Поправки Δc_pe (≤10 / ≤1)</label>
              <div class="row">
                <input type="number" step="0.1" id="deltaPe10" value="-0.2">
                <input type="number" step="0.1" id="deltaPe1" value="-0.4">
              </div>
              <div class="hint">Автоматически прибавляются к базовым <code>c_pe</code> при выборе классов ≤10 или ≤1 м².</div>
            </div>
          </div>

          <details>
            <summary>Расширенные настройки</summary>
            <div class="bd" style="padding:10px 0 0">
              <div class="row">
                <div>
                  <label>Ширина краевых полос стен: e = min(0.2·b, 0.2·h)</label>
                  <input type="number" step="0.01" id="eFactor" value="0.2">
                  <div class="hint">Для стен: <code>e</code> по меньшему из 0.2·b (поперёк ветра) и 0.2·h. В полосах — иные <code>c_pe</code>.</div>
                </div>
                <div>
                  <label>Кровля: e = k·min(b, 2h); k</label>
                  <input type="number" step="0.01" id="eRoofFactor" value="0.2">
                  <div class="hint">Для кровель: <code>b</code> — поперёк ветра. Обычно <code>k=0.2</code>.</div>
                </div>
              </div>

              <details>
                <summary>c_pe стен (базовые)</summary>
                <div class="row">
                  <div>
                    <label>Наветренная (D)</label>
                    <input id="cpeWallWindward" value="0.8">
                    <div class="hint">Коэф. внешнего давления на наветренную стену.</div>
                  </div>
                  <div>
                    <label>Боковые (A/B/C)</label>
                    <input id="cpeWallSide" value="-0.7,-0.7,-0.7">
                    <div class="hint">Коэф. для боковых зон A/B/C (краевые/средние полосы).</div>
                  </div>
                </div>
                <div class="row">
                  <div>
                    <label>Подветренная (E)</label>
                    <input id="cpeWallLeeward" value="-0.5">
                    <div class="hint">Коэф. внешнего давления на подветренную стену.</div>
                  </div>
                  <div><label class="hint">Значения по умолчанию ориентировочные — проверьте по вашей редакции СН 2.01.05‑2019.</label></div>
                </div>
              </details>

              <details>
                <summary>c_pe кровли (базовые)</summary>
                <div class="row">
                  <div>
                    <label>Плоская (F,G,H)</label>
                    <input id="cpeFlat" value="-1.5,-1.0,-0.7">
                    <div class="hint">F — наветр. кромка; G — боковые/подветр.; H — центр.</div>
                  </div>
                  <div>
                    <label>Двускатная θ=90° (α=15°: F,G,H,I)</label>
                    <input id="cpeGable15" value="-0.9,-0.7,-0.5,-0.3">
                    <div class="hint">Ветер ⟂ коньку, уклон 15°.</div>
                  </div>
                </div>
                <div class="row">
                  <div>
                    <label>Двускатная θ=90° (α=30°)</label>
                    <input id="cpeGable30" value="-1.1,-0.9,-0.6,-0.4">
                  </div>
                  <div>
                    <label>Двускатная θ=90° (α=45°)</label>
                    <input id="cpeGable45" value="-1.3,-1.0,-0.7,-0.5">
                  </div>
                </div>
                <div class="row">
                  <div>
                    <label>Двускатная θ=0° (α=15°: F,G,H,I,J)</label>
                    <input id="cpeGable0_15" value="0.2,-0.6,-0.9,-0.4,-0.3">
                    <div class="hint">Ветер ∥ коньку, уклон 15°.</div>
                  </div>
                  <div>
                    <label>Двускатная θ=0° (α=30°)</label>
                    <input id="cpeGable0_30" value="0.2,-0.7,-1.0,-0.5,-0.4">
                  </div>
                </div>
                <div class="hint">Для промежуточных уклонов — линейная интерполяция по <code>α</code>. Табличные значения сверяйте с СН.</div>
              </details>

              <details>
                <summary>Карта ветровых районов (vb,0)</summary>
                <div class="row">
                  <div>
                    <label>vb,0 для I/II/III (м/с)</label>
                    <input id="regionsMap" value="22,24,26">
                  </div>
                  <div><label class="hint">Эти значения подставляются при выборе района I/II/III.</label></div>
                </div>
              </details>

              <details>
                <summary>Высоты отсчёта z_e</summary>
                <div class="row">
                  <div>
                    <label>Режим</label>
                    <select id="zeMode">
                      <option value="auto" selected>Авто (стены/кровля = h; внутр. = h)</option>
                      <option value="manual">Вручную</option>
                    </select>
                    <div class="hint">По умолчанию <code>z_e</code> берётся на уровне <code>h</code>. При необходимости задайте отдельно внешнюю/внутреннюю высоты.</div>
                  </div>
                  <div></div>
                </div>
                <div class="row" id="zeManualRow" style="display:none">
                  <div><label>z_e,ext (внешнее), м</label><input type="number" step="0.1" id="zeExt" value="12"></div>
                  <div><label>z_e,int (внутреннее), м</label><input type="number" step="0.1" id="zeInt" value="12"></div>
                </div>
              </details>
            </div>
          </details>
        </div>
      </section>

      <!-- Правая панель: результаты -->
      <section class="card" aria-labelledby="results-h2">
        <div class="hd">
          <h2 id="results-h2">Результаты</h2>
          <div class="pill" id="status" role="status" aria-live="polite">Готов к расчёту…</div>
        </div>
        <div class="bd" id="results">
          <div class="kpi">
            <div class="itm"><div class="t">vb,0</div><div class="v" id="kpi-vb0">—</div></div>
            <div class="itm"><div class="t">vb</div><div class="v" id="kpi-vb">—</div></div>
            <div class="itm"><div class="t">Iv(h)</div><div class="v" id="kpi-iv">—</div></div>
            <div class="itm"><div class="t">qp(h), Па</div><div class="v" id="kpi-qp">—</div></div>
          </div>

          <div style="height:10px"></div>
          <div id="cases"></div>

          <div style="height:10px"></div>
          <h2 style="margin:0 0 6px">Подробный отчёт (только в PDF)</h2>
          <div class="report print-only" id="report">—</div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ===== Константы
    const RHO = 1.25;
    const Z0_MAP = { "0":0.003, "I":0.01, "II":0.05, "III":0.3, "IV":1.0 };
    const ZMIN_MAP = { "0":1, "I":1, "II":2, "III":5, "IV":10 };

    // ===== Утилиты
    const clamp=(v,min,max)=>Math.min(Math.max(v,min),max);
    const fmt=(v,d=2)=>Number.isFinite(v)?Number(v).toFixed(d):'—';
    const $=s=>document.querySelector(s);
    const $$=s=>Array.from(document.querySelectorAll(s));
    function parseList(str,expect=3){ const a=String(str).split(/[,;\s]+/).filter(Boolean).map(Number).filter(Number.isFinite); while(a.length<expect)a.push(a[a.length-1]??0); return a.slice(0,expect); }

    // ===== Профиль / qp
    function kCoef(z0){return 0.19*Math.pow(z0/0.05,0.07)}
    function cr(z,z0){const k=kCoef(z0);const zc=Math.max(z,1.0001*z0);return k*Math.log(zc/z0)}
    function Iv(z,z0){const zc=Math.max(z,1.0001*z0);return (1/Math.log(zc/z0))*Math.pow(z0/0.05,0.07)}
    function peakPressure(rho,vb,z,z0,co){const vm=cr(z,z0)*(co||1)*vb;const iv=Iv(z,z0);const qp=0.5*rho*vm*vm*(1+7*iv);return{vm,iv,qp}}

    // ===== Геометрия
    function zonesForWalls(L,B,H,eFactor,caseType){ const along=caseType==='long'?B:L; const across=caseType==='long'?L:B; const e=Math.min(eFactor*along, eFactor*H); return { e, along, across } }
    function eRoofFor(caseType,L,B,H){ const b=(caseType==='long')?B:L; const k=parseFloat($('#eRoofFactor').value)||0.2; return k*Math.min(b,2*H) }

    // ===== Расчётные хелперы
    function getCpiAbs(){ const m=$('#cpiMode').value; if(m==='manual') return Math.abs(parseFloat($('#cpi').value)||0); if(m==='autoSmall') return 0.2; if(m==='autoMedium') return 0.3; return 0.5 }
    function getCscd(apply){ const m=$('#cscdMode').value; if(!apply) return 1.0; if(m==='manual') return Math.max(0.5, parseFloat($('#cscd').value)||1); return 1.0 }
    function areaDelta(){ if($('#mode').value!=='cladding') return 0; const c=$('#areaClass').value; if(c==='<=1') return parseFloat($('#deltaPe1').value)||0; if(c==='<=10') return parseFloat($('#deltaPe10').value)||0; return 0 }
    function netPressure(cpeBase, qpExt, qpInt, applyCscd){ const d=areaDelta(); const cpe=(Number.isFinite(cpeBase)?cpeBase:0)+d; const cscd=getCscd(applyCscd); const we=cpe*qpExt*cscd; const cpi=getCpiAbs(); const w1=we - cpi*qpInt; const w2=we + cpi*qpInt; const wnet=Math.abs(w1)>=Math.abs(w2)?w1:w2; return{zone:'', cpe,we,wnet,cscd,cpi,delta:d} }

    // ===== Таблицы/блоки
    function buildTable(title,note,rows){ const thead=`<thead><tr><th>Зона</th><th>c<sub>pe</sub></th><th>w<sub>e</sub>=c<sub>pe</sub>·q<sub>p,ext</sub>·(c<sub>s</sub>c<sub>d</sub>)</th><th>w<sub>net</sub>=w<sub>e</sub>±c<sub>pi</sub>·q<sub>p,int</sub></th></tr></thead>`; const tbody=`<tbody>${rows.map(r=>`<tr><td>${r.zone}</td><td>${fmt(r.cpe,2)}</td><td>${fmt(r.we,0)}</td><td>${fmt(r.wnet,0)}</td></tr>`).join('')}</tbody>`; return `<div class="card" style="margin-top:12px"><div class="hd"><h2>${title}</h2><span class="pill">${note}</span></div><div class="bd"><table>${thead+tbody}</table></div></div>` }
    function buildCaseBlock(name,wallData,roofData){ return `<div class="card" style="margin-top:12px"><div class="hd"><h2>${name}</h2><span class="pill">Стены: e=${fmt(wallData.e,2)} м, фронт=${fmt(wallData.across,2)} м</span></div><div class="bd"><div class="row"><div>${buildTable('Наветренная','D',wallData.windward)}</div><div>${buildTable('Боковые','A/B/C',wallData.side)}</div></div><div style="height:8px"></div><div>${buildTable('Подветренная','E',wallData.leeward)}</div><div style="height:8px"></div><div>${buildTable(roofData.title,roofData.note,roofData.rows)}</div></div></div>` }

    // ===== Отчёт (для печати)
    function headerReport(ctx){ const {L,B,H,roofType,slope,theta,region,vb0,cdir,cseason,terrain,z0,zmin,co,zeExt,zeInt,rho,vb,ext,intp,mode}=ctx; const lines=[]; lines.push('— ВХОДНЫЕ ДАННЫЕ —'); lines.push(`L=${fmt(L,2)} м; B=${fmt(B,2)} м; h=${fmt(H,2)} м; кровля=${roofType==='flat'?'плоская':`двускатная (α=${fmt(slope,1)}°, θ=${theta}°)`}`); lines.push(`Регион=${region}; vb,0=${fmt(vb0,1)} м/с; cdir=${fmt(cdir,2)}; cseason=${fmt(cseason,2)}`); lines.push(`vb = vb,0·cdir·cseason = ${fmt(vb0,1)}·${fmt(cdir,2)}·${fmt(cseason,2)} = ${fmt(vb,2)} м/с`); lines.push(`Местность: ${terrain} → z0=${z0} м; zmin=${zmin} м; co=${fmt(co,2)}; ρ=${fmt(rho,2)} кг/м³`); lines.push(`z_e,ext=${fmt(zeExt,2)} м; z_e,int=${fmt(zeInt,2)} м`); lines.push('— ПРОФИЛЬ И q_p —'); const k=kCoef(z0); lines.push(`k_r=0.19·(z0/0.05)^0.07=${fmt(k,4)}`); lines.push(`cr(ext)=${fmt(cr(zeExt,z0),4)}; vm(ext)=${fmt(ext.vm,3)} м/с; Iv(ext)=${fmt(ext.iv,4)}; qp(ext)=${fmt(ext.qp,0)} Па`); lines.push(`cr(int)=${fmt(cr(zeInt,z0),4)}; vm(int)=${fmt(intp.vm,3)} м/с; Iv(int)=${fmt(intp.iv,4)}; qp(int)=${fmt(intp.qp,0)} Па`); lines.push('— РЕЖИМЫ —'); lines.push(`Режим: ${mode==='mwfrs'?'MWFRS':'Cladding'}`); const cpiTxt=(function(){const m=$('#cpiMode').value; if(m==='manual') return `c_pi=${fmt(Math.abs(parseFloat($('#cpi').value)||0),2)}`; if(m==='autoSmall') return 'c_pi=±0.20'; if(m==='autoMedium') return 'c_pi=±0.30'; return 'c_pi=±0.50'})(); lines.push(`Внутреннее: ${cpiTxt}`); const cscdTxt = (mode==='mwfrs')?`c_s c_d=${fmt(getCscd(true),2)}`:'c_s c_d=1.00 (не учитывается)'; lines.push(cscdTxt); if($('#mode').value==='cladding'){ lines.push(`Класс площади: ${$('#areaClass').value}; Δ≤10=${fmt(parseFloat($('#deltaPe10').value)||0,2)}; Δ≤1=${fmt(parseFloat($('#deltaPe1').value)||0,2)}`) } return lines }
    function zoneReport(title,rows,qpExt,qpInt){ const lines=[`\n— ${title} —`]; rows.forEach(r=>{ const wplus=r.we + r.cpi*qpInt; const wminus=r.we - r.cpi*qpInt; const picked=Math.abs(wplus)>=Math.abs(wminus)?'w_e + c_pi·q_p,int':'w_e - c_pi·q_p,int'; lines.push(`Зона ${r.zone}: c_pe=${fmt(r.cpe,2)}; w_e=${fmt(r.we,0)} Па; w_net=${picked} = ${fmt(r.wnet,0)} Па`) }); return lines }

    // ===== Основной расчёт
    function calc(){
      // Геометрия/кровля
      const L=parseFloat($('#L').value); const B=parseFloat($('#B').value); const H=parseFloat($('#H').value);
      const roofType=$('#roofType').value; const slope=parseFloat($('#slope').value||'0'); const theta=parseFloat($('#theta').value||'90');

      // Регион
      const region=$('#region').value; const [rI,rII,rIII]=parseList($('#regionsMap').value,3);
      if(region!=='custom'){ const map={I:rI, II:rII, III:rIII}; $('#vb0').value = map[region] ?? $('#vb0').value }
      const vb0=parseFloat($('#vb0').value);

      const cdir=parseFloat($('#cdir').value); const cseason=parseFloat($('#cseason').value);
      const terrain=$('#terrain').value; const co=parseFloat($('#co').value); const rho=Math.max(0.5, parseFloat($('#rho').value)||RHO);
      const eFactor=parseFloat($('#eFactor').value);

      const z0=Z0_MAP[terrain]; const zmin=ZMIN_MAP[terrain];
      const zeMode=$('#zeMode').value; const zeExtRaw=zeMode==='manual'?parseFloat($('#zeExt').value):H; const zeIntRaw=zeMode==='manual'?parseFloat($('#zeInt').value):H; const zeExt=Math.max(zeExtRaw,zmin); const zeInt=Math.max(zeIntRaw,zmin);

      const vb=cdir*cseason*vb0;
      const ext=peakPressure(rho,vb,zeExt,z0,co); const intp=peakPressure(rho,vb,zeInt,z0,co);

      // Наборы cpe кровли
      const cpeFlat=parseList($('#cpeFlat').value,3);
      const g15=parseList($('#cpeGable15').value,4), g30=parseList($('#cpeGable30').value,4), g45=parseList($('#cpeGable45').value,4);
      const g0_15=parseList($('#cpeGable0_15').value,5), g0_30=parseList($('#cpeGable0_30').value,5);

      // KPI
      $('#kpi-vb0').textContent = fmt(vb0,1)+' м/с';
      $('#kpi-vb').textContent  = fmt(vb,1)+' м/с';
      $('#kpi-iv').textContent  = fmt(ext.iv,3);
      $('#kpi-qp').textContent  = fmt(ext.qp,0);

      const casesEl=$('#cases'); casesEl.innerHTML='';
      const mode=$('#mode').value; const applyCscd=(mode==='mwfrs');

      function buildWalls(caseType){ const z=zonesForWalls(L,B,H,eFactor,caseType); const w=netPressure(parseList($('#cpeWallWindward').value,1)[0], ext.qp, intp.qp, applyCscd); w.zone='D'; const sVals=parseList($('#cpeWallSide').value,3); const s=['A','B','C'].map((zone,i)=>({zone, ...netPressure(sVals[i], ext.qp, intp.qp, applyCscd)})); const e=[{zone:'E', ...netPressure(parseList($('#cpeWallLeeward').value,1)[0], ext.qp, intp.qp, applyCscd)}]; return { ...z, windward:[w], side:s, leeward:e } }
      function buildRoof(caseType){ const eR=eRoofFor(caseType,L,B,H); if(roofType==='flat'){ const rows=['F','G','H'].map((z,i)=>({zone:z, ...netPressure(cpeFlat[i], ext.qp, intp.qp, applyCscd)})); return {title:'Покрытие (плоское)', note:`e=${fmt(eR,2)} м`, rows} } else { if(theta===90){ const set=(slope<=22.5)?interp(slope,g15,15,g30,30):interp(slope,g30,30,g45,45); const rows=['F','G','H','I'].map((z,i)=>({zone:z, ...netPressure(set[i], ext.qp, intp.qp, applyCscd)})); return {title:`Покрытие (двускатное, θ=90°, α=${fmt(slope,1)}°)`, note:`e=${fmt(eR,2)} м`, rows} } else { const set0=(slope<=22.5)?g0_15:g0_30; const rows=['F','G','H','I','J'].map((z,i)=>({zone:z, ...netPressure(set0[i], ext.qp, intp.qp, applyCscd)})); return {title:`Покрытие (двускатное, θ=0°, α=${fmt(slope,1)}°)`, note:`e=${fmt(eR,2)} м`, rows} } } }

      const wallsLong=buildWalls('long'); const wallsShort=buildWalls('short');
      const roofLong=buildRoof('long'); const roofShort=buildRoof('short');

      casesEl.insertAdjacentHTML('beforeend',
        buildCaseBlock('Случай A — ветер на длинную грань', wallsLong, roofLong) +
        buildCaseBlock('Случай B — ветер на короткую грань', wallsShort, roofShort)
      );

      // Отчёт для печати
      const ctx={L,B,H,roofType,slope,theta,region,vb0,cdir,cseason,terrain,z0,zmin,co,zeExt,zeInt,rho,vb,ext,intp,mode};
      const lines=[...headerReport(ctx)];
      function allRows(w,r){ return [].concat(w.windward,w.side,w.leeward,r.rows) }
      lines.push('\n— СЛУЧАЙ A —'); lines.push(...zoneReport('Стены и покрытие', allRows(wallsLong,roofLong), ext.qp, intp.qp));
      lines.push('\n— СЛУЧАЙ B —'); lines.push(...zoneReport('Стены и покрытие', allRows(wallsShort,roofShort), ext.qp, intp.qp));
      lines.push('\nПримечание: значения c_pe базовые; при расчёте крепежей используйте локальные коэффициенты из таблиц СН.');
      $('#report').textContent = lines.join('\n');

      status('Готово. Расчёт обновлён.','ok');
    }

    // ===== Служебное
    function status(msg,tone=''){ const el=$('#status'); el.textContent=msg; el.style.background=tone==='ok'?'#13243a':'#16203a' }
    function copyResults(){ const t=$('#report').innerText.trim(); if(!t){status('Нечего копировать',''); return} navigator.clipboard.writeText(t).then(()=>status('Отчёт скопирован','ok')) }
    function interp(a,setA,aA,setB,aB){ const t=clamp((a-aA)/(aB-aA),0,1); return setA.map((v,i)=> v + (setB[i]-v)*t ) }

    // ===== События
    document.addEventListener('click', (e)=>{ const act=e.target.closest('[data-action]')?.dataset.action; if(!act) return; if(act==='calc') calc(); if(act==='print') window.print(); if(act==='copy') copyResults(); });
    $('#roofType').addEventListener('change', e=>{ $('#slopeRow').style.display = e.target.value==='gable' ? '' : 'none' });
    $('#zeMode').addEventListener('change', e=>{ $('#zeManualRow').style.display = e.target.value==='manual' ? '' : 'none' });
    let t; $$('.bd input, .bd select').forEach(el=> el.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(calc,180) }));
    window.addEventListener('load', calc);
  </script>
</body>
</html>
